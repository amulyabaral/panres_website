{% extends "base.html" %}

{% block title %}Details for {{ item_id }} - {{ site_name }}{% endblock %}

{# Override header content specifically for details page to add citation #}
{% block header_content %}
    <div class="header-citation">
        <h4>Please Cite:</h4>
        <p>{{ citation_text|safe }}</p>
    </div>
{% endblock %}


{% block content %}

{# --- Unified Details Layout --- #}
<div class="details-container"> {# Use a general container class #}
    {# Item ID Highlight #}
    <h2 class="item-id-highlight"><code>{{ item_id }}</code></h2>

    {# Display primary type #}
    {% if details.primary_type_display %}
        <p class="item-type-subheader"> {# General class name #}
            {% if details.primary_type_category_key %}
                <a href="{{ url_for('list_items', category_key=details.primary_type_category_key) }}">{{ details.primary_type_display }}</a>
            {% else %}
                {{ details.primary_type_display }} {# Display without link if no key #}
            {% endif %}
            {# Optionally list other types #}
            {% set other_types = [] %}
            {# Filter out the primary display type and common RDF types #}
            {% set excluded_types_display = [details.primary_type_display, 'owl:NamedIndividual'] %}
            {% for type_uri in details.types %}
                 {# Simple check: if the URI doesn't match the primary display name and isn't owl:NamedIndividual #}
                 {# A more robust check might involve fetching labels, but this uses available data #}
                 {% if type_uri not in excluded_types_display %}
                     {# Display the URI directly as we don't have separate display names for all types #}
                     {% set _ = other_types.append("<code>" ~ type_uri ~ "</code>") %}
                 {% endif %}
            {% endfor %}
            {% if other_types %}
                (Type: {{ other_types|join(', ')|safe }})
            {% endif %}
        </p>
    {% endif %}

    {# --- NEW: Grid for Property Cards --- #}
    <div class="details-property-grid">

        {# --- Card 1: Key Identifiers --- #}
        {% set key_preds = ['has_length', 'accession', 'card_link'] %}
        {% set has_key_info = key_preds | select('in', details.grouped_properties) | list | length > 0 %}
        {% if has_key_info %}
        <div class="details-card">
            <h3>Key Information</h3>
            <dl class="details-list">
                {% for predicate in key_preds %}
                    {% if predicate in details.grouped_properties %}
                        <dt>{{ predicate_map.get(predicate, predicate) }}</dt>
                        <dd>
                            <ul class="property-values">
                                {% for prop in details.grouped_properties[predicate] %}
                                    <li>
                                        {% if prop.is_literal %}
                                            {{ prop.value }}
                                        {% elif prop.link and predicate == 'card_link' %} {# Special case for CARD link #}
                                            <a href="{{ prop.link }}" target="_blank" rel="noopener noreferrer" class="prop-link prop-link-external">
                                                {{ prop.value }} <span class="external-icon">â†—</span>
                                            </a>
                                        {% elif prop.link %}
                                             <a href="{{ prop.link }}" class="prop-link prop-link-general"><code>{{ prop.value }}</code></a>
                                        {% else %}
                                            <code>{{ prop.value }}</code>
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            </ul>
                        </dd>
                    {% endif %}
                {% endfor %}
            </dl>
        </div>
        {% endif %}
        {# --- End Card 1 --- #}

        {# --- Card 2: Equivalents / Aliases --- #}
        {% set equiv_pred = 'same_as' %}
        {% if equiv_pred in details.grouped_properties %}
        <div class="details-card">
            <h3>{{ predicate_map.get(equiv_pred, equiv_pred) }}</h3>
            <dl class="details-list">
                <dt>{{ predicate_map.get(equiv_pred, equiv_pred) }}</dt> {# Repeat title as dt for consistency #}
                <dd>
                    <ul class="property-values">
                        {% for prop in details.grouped_properties[equiv_pred] %}
                            <li>
                                {% if prop.link %}
                                    <a href="{{ prop.link }}" class="prop-link prop-link-equiv"><code>{{ prop.value }}</code></a>
                                {% else %}
                                    <code>{{ prop.value }}</code>
                                {% endif %}
                                {% if prop.extra_info %}<span class="extra-info">{{ prop.extra_info }}</span>{% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                </dd>
            </dl>
        </div>
        {% endif %}
        {# --- End Card 2 --- #}

        {# --- Card 3: Resistance Information --- #}
        {% set resistance_preds = ['has_resistance_class', 'has_predicted_phenotype'] %}
        {% set has_resistance_info = resistance_preds | select('in', details.grouped_properties) | list | length > 0 %}
        {% if has_resistance_info %}
        <div class="details-card">
            <h3>Resistance Profile</h3>
            <dl class="details-list">
                {% for predicate in resistance_preds %}
                    {% if predicate in details.grouped_properties %}
                        <dt>{{ predicate_map.get(predicate, predicate) }}</dt>
                        <dd>
                            <ul class="property-values property-values-buttons"> {# Add class for button layout #}
                                {% for prop in details.grouped_properties[predicate] %}
                                    <li>
                                        {% if prop.link %}
                                            {# Assign class based on predicate #}
                                            {% set link_class = 'prop-link-general' %}
                                            {% if predicate == 'has_resistance_class' %}
                                                {% set link_class = 'prop-link-class' %}
                                            {% elif predicate == 'has_predicted_phenotype' %}
                                                {% set link_class = 'prop-link-pheno' %}
                                            {% endif %}
                                            <a href="{{ prop.link }}" class="prop-link {{ link_class }}"><code>{{ prop.value }}</code></a>
                                        {% else %}
                                            <code>{{ prop.value }}</code>
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            </ul>
                        </dd>
                    {% endif %}
                {% endfor %}
            </dl>
        </div>
        {% endif %}
        {# --- End Card 3 --- #}

        {# --- Card 4: Biological Context --- #}
        {% set bio_preds = ['translates_to', 'member_of'] %}
        {% set has_bio_info = bio_preds | select('in', details.grouped_properties) | list | length > 0 %}
        {% if has_bio_info %}
        <div class="details-card">
            <h3>Biological Context</h3>
            <dl class="details-list">
                 {% for predicate in bio_preds %}
                    {% if predicate in details.grouped_properties %}
                        <dt>{{ predicate_map.get(predicate, predicate) }}</dt>
                        <dd>
                            <ul class="property-values">
                                {% for prop in details.grouped_properties[predicate] %}
                                    <li>
                                        {% if prop.link %}
                                             <a href="{{ prop.link }}" class="prop-link prop-link-bio"><code>{{ prop.value }}</code></a>
                                        {% else %}
                                            <code>{{ prop.value }}</code>
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            </ul>
                        </dd>
                    {% endif %}
                {% endfor %}
            </dl>
        </div>
        {% endif %}
        {# --- End Card 4 --- #}

        {# --- Card 5: Source Databases --- #}
        {% set source_pred = 'is_from_database' %}
        {% if source_pred in details.grouped_properties %}
        <div class="details-card">
            <h3>{{ predicate_map.get(source_pred, source_pred) }}</h3>
            <dl class="details-list">
                 <dt>{{ predicate_map.get(source_pred, source_pred) }}</dt> {# Repeat title as dt #}
                 <dd>
                     <ul class="property-values property-values-buttons"> {# Add class for button layout #}
                         {% for prop in details.grouped_properties[source_pred] %}
                             <li>
                                 {% if prop.link %}
                                     <a href="{{ prop.link }}" class="prop-link prop-link-db"><code>{{ prop.value }}</code></a>
                                 {% else %}
                                     <code>{{ prop.value }}</code>
                                 {% endif %}
                             </li>
                         {% endfor %}
                     </ul>
                 </dd>
            </dl>
        </div>
        {% endif %}
        {# --- End Card 5 --- #}

        {# --- Card X: Other Properties (Catch-all) --- #}
        {% set handled_preds = key_preds + [equiv_pred] + resistance_preds + bio_preds + [source_pred, RDFS_LABEL, RDFS_COMMENT] %}
        {% set other_properties = {} %}
        {% for predicate, properties_list in details.grouped_properties.items() %}
            {% if predicate not in handled_preds %}
                 {% set _ = other_properties.update({predicate: properties_list}) %}
            {% endif %}
        {% endfor %}
        {% if other_properties %}
        <div class="details-card">
            <h3>Other Properties</h3>
            <dl class="details-list">
                {% for predicate, properties_list in other_properties.items() %}
                    <dt>{{ predicate_map.get(predicate, predicate) }}</dt>
                    <dd>
                        <ul class="property-values">
                            {% for prop in properties_list %}
                                <li>
                                    {% if prop.is_literal %}
                                        {{ prop.value }}
                                    {% elif prop.link %}
                                        <a href="{{ prop.link }}" class="prop-link prop-link-general"><code>{{ prop.value }}</code></a>
                                    {% else %}
                                        <code>{{ prop.value }}</code>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    </dd>
                {% endfor %}
            </dl>
        </div>
        {% endif %}
        {# --- End Card X --- #}

    </div> {# --- End details-property-grid --- #}


    {# Referenced By Section (Keep As Is) #}
    <div class="details-card referenced-by">
        <h3>Referenced By</h3>
        {% if details.referencing_items %} {# Use details.referencing_items now #}
            <dl class="details-list">
                {% for ref_item in details.referencing_items %} {# Use details.referencing_items #}
                    <dt>{{ predicate_map.get(ref_item.predicate, ref_item.predicate) }}</dt>
                    <dd><a href="{{ url_for('details', item_id=ref_item.ref_id) }}"><code>{{ ref_item.ref_id }}</code></a></dd>
                {% endfor %}
            </dl>
        {% else %}
            <p>This item is not referenced by any other items.</p>
        {% endif %}
    </div>

</div> {# End details-container #}


{# Back Links Footer (Keep As Is - url_for should work now) #}
<div class="back-links-footer">
    <p class="back-link"><a href="{{ url_for('index') }}">&laquo; Back to Home</a></p>
    {# Link back to the primary category list if available #}
    {% if details.primary_type_category_key %}
         <p class="back-link"><a href="{{ url_for('list_items', category_key=details.primary_type_category_key) }}">&laquo; Back to {{ details.primary_type_display }} list</a></p>
    {% endif %}
</div>

{% endblock %} 