{% extends "base.html" %}

{% block title %}{{ site_name }} - Home{% endblock %}

{% block content %}

    {# *** START ERROR DISPLAY BLOCK *** #}
    {% if show_error %}
    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-md shadow-md" role="alert">
        <p class="font-bold">Error {{ error_code }}</p>
        <p>{{ error_message | default('An unexpected error occurred.', true) }}</p>
        <p class="mt-2 text-sm">You can try returning to the <a href="{{ url_for('index') }}" class="font-medium hover:underline">Homepage</a>.</p>
    </div>
    {% endif %}
    {# *** END ERROR DISPLAY BLOCK *** #}

    {# --- Show content only if NOT showing an error --- #}
    {% if not show_error %}

    {# --- About PanRes Section --- #}
    <section class="mb-12">
        <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
            <h2 class="text-3xl font-semibold text-gray-800 mb-3">{{ site_name }}</h2>
            <p class="text-gray-600 text-sm">
                PanRes (Pan Resistance) is a unified collection of genes conferring resistance to antibiotics, heavy metals, and biocides.
                It aggregates unique gene sequences from established databases like ResFinder, CARD, MegaRes, AMRFinderPlus, ARGANNOT, BacMet,
                and functionally verified genes from recent studies.
            </p>
        </div>
    </section>

    {# --- Browse Categories Section --- #}
    <section class="mb-12">
        <h3 class="text-2xl font-semibold text-gray-700 mb-6 text-center">Browse Data</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            {# Standard Card Style #}
            {# Loop through the configuration dict #}
            {% for key, info in index_categories.items() %}
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 hover:shadow-lg transition-shadow duration-200 flex flex-col">
                <h4 class="text-xl font-semibold text-dtu-red mb-2">{{ key }}</h4>
                <p class="text-gray-600 text-sm mb-4 flex-grow">{{ info.description }}</p>
                <div class="text-sm text-gray-500 mb-4">
                    {# Access the count from the category_counts dict using the key #}
                    <span class="font-medium">{{ category_counts.get(key, 'N/A') }}</span> items
                </div>
                {# Apply button utilities directly instead of .btn #}
                <a href="{{ url_for('list_items', category_key=key) }}"
                   class="mt-auto inline-block bg-dtu-red hover:bg-opacity-80 text-white px-4 py-2 rounded text-sm font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-dtu-red focus:ring-offset-2 text-center">
                    View {{ key }}
                </a>
            </div>
            {% else %}
            <p class="text-gray-500 italic md:col-span-2 lg:col-span-4 text-center">No categories found.</p>
            {% endfor %}
        </div>
    </section>

    {# --- Charts Section (Combined Card) --- #}
    <section class="mb-12">
        <h3 class="text-2xl font-semibold text-gray-700 mb-6 text-center">PanRes 2.0 Overview</h3>

        {# Single Card Container for all charts #}
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-md border border-gray-200">

            {# Grid for top two charts (Pie and Bar) #}
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8 mb-6 lg:mb-8">

                {# Antibiotic Classes Chart Card (Pie) #}
                <div class="flex flex-col"> {# Removed card styling, just a container #}
                    <h4 class="text-lg font-semibold text-gray-700 mb-2 text-center">Genes per Antibiotic Class</h4>
                    <p class="text-gray-600 text-sm mb-4 text-center">Distribution across resistance classes</p>
                    {% if antibiotic and antibiotic.data %}
                        {# Adjusted height, use relative for positioning #}
                        <div class="relative h-64 md:h-80 mx-auto w-full max-w-sm mb-4">
                            <canvas id="antibiotic"></canvas>
                        </div>
                        {# Button #}
                        <div class="mt-auto text-center">
                            <a href="{{ url_for('list_items', category_key='Antibiotic Classes') }}"
                               class="inline-block bg-dtu-red hover:bg-opacity-80 text-white px-4 py-2 rounded text-sm font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-dtu-red focus:ring-offset-2">
                                Browse by Class
                            </a>
                        </div>
                    {% else %}
                        <p class="text-gray-500 italic text-center py-4">No data available for antibiotic classes chart.</p>
                    {% endif %}
                </div>

                {# Source Databases Chart Card (Bar) #}
                <div class="flex flex-col"> {# Removed card styling, just a container #}
                    <h4 class="text-lg font-semibold text-gray-700 mb-2 text-center">Genes per Source Database</h4>
                    <p class="text-gray-600 text-sm mb-4 text-center">Contributions from source databases</p>
                    {% if source_db and source_db.segments %}
                        {# Adjusted height, use relative for positioning #}
                        <div class="relative h-64 md:h-80 mx-auto w-full mb-4">
                            <canvas id="sourceDb"></canvas>
                        </div>
                        {# Button #}
                        <div class="mt-auto text-center">
                            <a href="{{ url_for('list_items', category_key='Source Databases') }}"
                               class="inline-block bg-dtu-red hover:bg-opacity-80 text-white px-4 py-2 rounded text-sm font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-dtu-red focus:ring-offset-2">
                                Browse by Source
                            </a>
                        </div>
                    {% else %}
                        <p class="text-gray-500 italic text-center py-4">No data available for source databases chart.</p>
                    {% endif %}
                </div>
            </div> {# End of grid for top two charts #}

            {# Divider (Optional) #}
            <hr class="my-4 md:my-6 border-gray-200">

            {# Container for the bottom chart (Phenotype Stacked Bar) #}
            <div class="flex flex-col"> {# Removed card styling, just a container #}
                 <h4 class="text-lg font-semibold text-gray-700 mb-2 text-center">Predicted Phenotype Proportions</h4>
                 <p class="text-gray-600 text-sm mb-4 text-center">Relative distribution of phenotypes across PanGenes</p>
                 {% if phenotype and phenotype.segments %}
                     {# Make container wider and adjust height #}
                     {# Reduced height slightly as labels are now inside #}
                     <div class="relative h-20 md:h-24 w-full mx-auto mb-4">
                         <canvas id="phenotype"></canvas>
                     </div>
                     {# Button #}
                     <div class="mt-auto text-center">
                         <a href="{{ url_for('list_items', category_key='Predicted Phenotypes') }}"
                            class="inline-block bg-dtu-red hover:bg-opacity-80 text-white px-4 py-2 rounded text-sm font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-dtu-red focus:ring-offset-2">
                             Browse by Phenotype
                         </a>
                     </div>
                 {% else %}
                     <p class="text-gray-500 italic text-center py-4">No phenotype data available.</p>
                 {% endif %}
            </div> {# End of container for bottom chart #}

        </div> {# End of Single Card Container #}
    </section>

    {# --- Citation Section (Only show if NOT showing an error) --- #}
    <section class="bg-gray-100 p-6 rounded-lg border border-gray-200 shadow-sm">
        <h3 class="text-xl font-semibold text-gray-700 mb-3">Citation</h3>
        <p class="text-gray-600 text-sm">
            If you use the PanRes database or website, please cite:
        </p>
        <blockquote class="mt-2 text-sm text-gray-800 border-l-4 border-dtu-red pl-4 italic">
            {{ citation_text | safe }}
        </blockquote>
    </section>
    {% endif %} {# End of "if not show_error" block #}

{% endblock %}

{% block scripts %}
    {# Chart.js Scripts are now in base.html #}
    {# Custom JS for Charts #}
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const isErrorPage = document.querySelector('.bg-red-100[role="alert"]');
        if (isErrorPage) {
            console.log("Error page detected, skipping chart initialization.");
            return;
        }

        // Register the datalabels plugin globally
        // Make sure ChartDataLabels is the correct global variable name provided by the plugin script
        if (typeof ChartDataLabels !== 'undefined') {
            Chart.register(ChartDataLabels);
        } else {
            console.warn('ChartDataLabels plugin not found. Percentages on stacked bar chart will not be displayed.');
        }


        // Parse JSON data
        const pieCfg       = JSON.parse('{{ antibiotic | tojson | safe }}');
        const barCfg       = JSON.parse('{{ source_db  | tojson | safe }}');
        const stackedCfg   = JSON.parse('{{ phenotype  | tojson | safe }}');

        /* helpers â€“ one per chart style */
        const pie = (id, d) => new Chart(id, {
          type: 'pie',
          data: {
              labels: d.labels,
              datasets:[{
                  data:d.data,
                  backgroundColor:d.colors // Use colors from Python
              }]
          },
          options:{
              responsive: true,
              maintainAspectRatio: false, // Allow canvas to fill container height/width
              plugins:{
                  legend:{ display: true, position: 'bottom', labels: { boxWidth: 12 } }, // Keep legend for pie
                  tooltip: {
                      callbacks: { // Optional: Format tooltip
                          label: function(context) {
                              let label = context.label || '';
                              if (label) {
                                  label += ': ';
                              }
                              if (context.parsed !== null) {
                                  // Calculate percentage for tooltip
                                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                  const value = context.raw;
                                  const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                  label += `${value} (${percentage}%)`;
                              }
                              return label;
                          }
                      }
                  }
              }
          }
        });

        const bar = (id, d) => new Chart(id, {
          type:'bar',
          data:{
            labels:d.segments.map(s=>s.name),
            datasets:[{
                data:d.segments.map(s=>s.count),
                backgroundColor:d.segments.map(s=>s.color) // Use colors from Python
            }]
          },
          options:{
            indexAxis:'y',
            responsive: true,
            maintainAspectRatio: false, // Allow canvas to fill container height/width
            plugins:{ legend:{display:false} }, // No legend for bar
            scales:{
                // Adjust padding/position if labels overlap
                y:{ position:'left', ticks: { autoSkip: false, padding: 5 } }, // Keep labels on left
                x:{ beginAtZero:true }
            }
          }
        });

        const stacked = (id, d) => new Chart(id, {
          type:'bar',
          data:{
            labels:['Predicted Phenotypes'], // Single category label for the axis (not displayed)
            // Map segments to datasets, including the percentage for the datalabels plugin
            datasets: d.segments.map(s => ({
                label: s.name, // Used for tooltip
                data: [s.percentage], // Use percentage as the data value for the bar length
                backgroundColor: s.color, // Use color from Python
                // Store count and raw percentage for potential use in tooltips/labels if needed
                count: s.count,
                percentage: s.percentage
            }))
          },
          options:{
            indexAxis:'y',
            responsive:true,
            maintainAspectRatio: false, // Allow canvas to fill container height/width
            scales:{
                x:{ stacked:true, display: true, max: 100, ticks: { callback: value => value + '%' } }, // Show X-axis with %
                y:{ stacked:true, display:false } // Hide Y-axis labels/ticks
            },
            plugins:{
                legend:{ display: false }, // Hide legend
                tooltip: {
                    callbacks: { // Custom tooltip to show name and original count/percentage
                         label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            // Access the original count and percentage stored in the dataset
                            const count = context.dataset.count;
                            const percentage = context.dataset.percentage;
                            if (count !== undefined && percentage !== undefined) {
                                label += `${count} (${percentage.toFixed(1)}%)`;
                            } else {
                                // Fallback if data is missing
                                label += context.formattedValue + '%';
                            }
                            return label;
                        }
                    }
                },
                // Configure datalabels plugin
                datalabels: {
                    // Display the percentage inside the bar segments
                    formatter: (value, context) => {
                        // 'value' here is the percentage we put in data: [s.percentage]
                        // Only show label if percentage is large enough to fit
                        return value > 5 ? value.toFixed(1) + '%' : '';
                    },
                    color: '#ffffff', // White text for contrast
                    // Optional: Add stroke or background for better readability on similar colors
                    // textStrokeColor: 'black',
                    // textStrokeWidth: 1,
                    font: {
                        weight: 'bold'
                    }
                }
            }
          }
        });

        // Initialize charts if data exists
        if (pieCfg)       pie(document.getElementById('antibiotic'), pieCfg);
        if (barCfg)       bar(document.getElementById('sourceDb'),  barCfg);
        if (stackedCfg)   stacked(document.getElementById('phenotype'), stackedCfg);
      });
    </script>
{% endblock %} 