<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ site_name }} - Home</title>

    {# Add Tailwind CSS via CDN #}
    <script src="https://cdn.tailwindcss.com"></script>

    {# Link to your simplified custom CSS #}
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <link rel="icon" href="{{ url_for('static', filename='panres_logo.png') }}" type="image/png">

    {# Basic Tailwind Configuration #}
    <script>
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                'dtu-red': '#990000', // Define the primary red color
              },
              fontFamily: {
                // Use Tailwind's default sans-serif stack
                sans: ['ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Roboto', '"Helvetica Neue"', 'Arial', '"Noto Sans"', 'sans-serif', '"Apple Color Emoji"', '"Segoe UI Emoji"', '"Segoe UI Symbol"', '"Noto Color Emoji"'],
                mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', '"Liberation Mono"', '"Courier New"', 'monospace'],
              }
            }
          }
        }
      </script>
      <style type="text/tailwindcss">
        /* Add custom base styles or component overrides here if needed */
        body {
            @apply font-sans bg-gray-50 text-gray-800;
        }
        .btn {
            @apply inline-block bg-dtu-red/80 hover:bg-dtu-red text-white px-4 py-2 rounded text-sm font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-dtu-red focus:ring-offset-2;
        }
        code {
             @apply bg-gray-200 text-gray-700 px-1 py-0.5 rounded text-sm font-mono;
        }
        /* Style for the DTU background pattern on the header */
        .dtu-pattern-bg {
            background-image: url("{{ url_for('static', filename='DTU_Background_Pattern_Corporate_Red_RGB.jpg') }}");
            background-color: #990000; /* DTU Red fallback */
            background-size: cover; /* Cover the area */
            background-position: center center;
            background-repeat: no-repeat;
        }
      </style>
</head>
<body class="flex flex-col min-h-screen">

    {# --- Header --- #}
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            {# Left side: Logo and Title #}
            <div class="flex items-center space-x-4">
                 <a href="{{ url_for('index') }}">
                    <img src="{{ url_for('static', filename='panres_logo.png') }}" alt="PanRes Logo" class="h-10">
                 </a>
                 <div>
                    <h1 class="text-xl font-semibold text-gray-700">Centre for Genomic Epidemiology</h1>
                    <div class="text-sm text-gray-500">PanRes 2.0 Database</div>
                 </div>
            </div>
            {# Right side: Maybe external links if needed later, keep simple for now #}
            <div>
                {# Placeholder for potential future links like "About" or "Help" #}
            </div>
        </div>
    </header>

    {# --- Main Content Area --- #}
    <main class="container mx-auto px-4 py-8 flex-grow">

        {# --- Info and Citation Card --- #}
        <div class="bg-white rounded-md shadow-lg p-6 mb-8">
            <h3 class="text-xl font-medium text-dtu-red mb-3">PanRes 2.0 Database Information</h3>
            <p class="text-gray-700 mb-4">
                Welcome to the PanRes 2.0 database, a curated collection of antimicrobial resistance (AMR) genes.
                Explore the data using the charts and browse buttons below.
            </p>
            <hr class="my-4 border-gray-200">
            <h4 class="text-lg font-medium text-dtu-red mb-2">Citation</h4>
            <p class="text-sm text-gray-700">{{ citation_text|safe }}</p>
        </div>


        {# --- Main Grid for Visualizations and Categories --- #}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">

            {# --- Left Column: Charts --- #}
            <div class="space-y-6">

                {# --- Source Database Visualization --- #}
                <div class="bg-white rounded-md shadow-lg p-4">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200">
                        <h4 class="text-lg font-medium text-dtu-red">ARGs by Source Database</h4>
                        {# Link to the list page for this category #}
                        <a href="{{ url_for('list_items', category_key='Source Databases') }}" class="btn">Browse Sources</a>
                    </div>
                    {% if source_db_chart_data and source_db_chart_data.segments %}
                        <div class="w-full h-8 bg-gray-200 rounded-full overflow-hidden flex mb-4" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" aria-label="Distribution by Source Database">
                            {% for segment in source_db_chart_data.segments %}
                                <div class="h-full transition-all duration-500 ease-out" {# Tailwind class for the bar segment #}
                                     data-target-width="{{ segment.percentage }}%"
                                     style="background-color: {{ segment.color }}; width: 0%;" {# Start width at 0 for animation #}
                                     title="{{ segment.name }} ({{ '{:,}'.format(segment.count) }} genes, {{ '%.1f'|format(segment.percentage) }}%)">
                                </div>
                            {% endfor %}
                        </div>
                        <div class="text-xs space-y-1">
                            {% for segment in source_db_chart_data.segments %}
                            {# Link to the details page for the specific database #}
                            <a href="{{ url_for('details', item_id=segment.name) }}" title="View details for {{ segment.name }}" class="flex items-center group">
                                <span class="inline-block w-3 h-3 rounded-sm mr-1.5 border border-gray-400" style="background-color: {{ segment.color }};"></span>
                                <span class="text-gray-700 group-hover:text-dtu-red group-hover:underline">{{ segment.name }}</span>
                                <span class="text-gray-500 ml-1">({{ '{:,}'.format(segment.count) }})</span>
                            </a>
                            {% endfor %}
                        </div>
                        <p class="text-xs text-gray-500 mt-2 text-right">Total Original Genes: {{ '{:,}'.format(source_db_chart_data.total_count) }}</p>
                    {% else %}
                        <p class="text-gray-500 italic text-center py-4">No source database data available.</p>
                    {% endif %}
                </div>

                {# --- Predicted Phenotype Visualization --- #}
                <div class="bg-white rounded-md shadow-lg p-4">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200">
                        <h4 class="text-lg font-medium text-dtu-red">PanGenes by Predicted Phenotype</h4>
                        {# Link to the list page for this category #}
                        <a href="{{ url_for('list_items', category_key='Predicted Phenotypes') }}" class="btn">Browse Phenotypes</a>
                    </div>
                    {% if phenotype_chart_data and phenotype_chart_data.segments %}
                        <div class="w-full h-8 bg-gray-200 rounded-full overflow-hidden flex mb-4" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" aria-label="Distribution by Predicted Phenotype">
                            {% for segment in phenotype_chart_data.segments %}
                                <div class="h-full transition-all duration-500 ease-out" {# Tailwind class for the bar segment #}
                                     data-target-width="{{ segment.percentage }}%"
                                     style="background-color: {{ segment.color }}; width: 0%;" {# Start width at 0 for animation #}
                                     title="{{ segment.name }} ({{ '{:,}'.format(segment.count) }} genes, {{ '%.1f'|format(segment.percentage) }}%)">
                                </div>
                            {% endfor %}
                        </div>
                        <div class="text-xs space-y-1 max-h-40 overflow-y-auto"> {# Limit height and add scroll if many phenotypes #}
                            {% for segment in phenotype_chart_data.segments %}
                            {# Link to the list page, filtered by this phenotype #}
                            <a href="{{ url_for('list_items', predicate='has_predicted_phenotype', object_value=segment.name) }}" title="View genes with phenotype {{ segment.name }}" class="flex items-center group">
                                <span class="inline-block w-3 h-3 rounded-sm mr-1.5 border border-gray-400" style="background-color: {{ segment.color }};"></span>
                                <span class="text-gray-700 group-hover:text-dtu-red group-hover:underline">{{ segment.name }}</span>
                                <span class="text-gray-500 ml-1">({{ '{:,}'.format(segment.count) }})</span>
                            </a>
                            {% endfor %}
                        </div>
                         <p class="text-xs text-gray-500 mt-2 text-right">Total PanGenes: {{ '{:,}'.format(phenotype_chart_data.total_count) }}</p>
                    {% else %}
                        <p class="text-gray-500 italic text-center py-4">No phenotype data available.</p>
                    {% endif %}
                </div>

            </div> {# End Left Column #}

            {# --- Right Column: Pie Chart and Categories --- #}
            <div class="space-y-6">

                 {# --- Antibiotic Class Pie Chart --- #}
                <div class="bg-white rounded-md shadow-lg p-4">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200">
                        <h4 class="text-lg font-medium text-dtu-red">PanGenes by Antibiotic Class</h4>
                         {# Link to the list page for this category #}
                        <a href="{{ url_for('list_items', category_key='Antibiotic Classes') }}" class="btn">Browse Classes</a>
                    </div>
                    {% if antibiotic_chart_data and antibiotic_chart_data.labels %}
                        <div class="chart-container mx-auto" style="max-width: 400px;"> {# Constrain pie chart size #}
                            <canvas id="antibioticClassChart"></canvas>
                        </div>
                         <p class="text-xs text-gray-500 mt-2 text-center">Total PanGenes: {{ '{:,}'.format(antibiotic_chart_data.total_count) }}</p>
                    {% else %}
                        <p class="text-gray-500 italic text-center py-4">No antibiotic class data available.</p>
                    {% endif %}
                </div>

                {# --- Browse Categories Section --- #}
                <div class="bg-white rounded-md shadow-lg p-4">
                    <h4 class="text-lg font-medium text-dtu-red mb-4 pb-2 border-b border-gray-200">Browse Ontology</h4>
                    <div class="space-y-3">
                        {% for key, config in index_categories.items() %}
                        <div class="flex justify-between items-center">
                            <div>
                                <h5 class="font-semibold">{{ key }}</h5>
                                {% if config.description %}
                                <p class="text-sm text-gray-600">{{ config.description }}</p>
                                {% endif %}
                            </div>
                            <a href="{{ url_for('list_items', category_key=key) }}" class="btn">
                                View ({{ category_counts.get(key, 0) }})
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>

            </div> {# End Right Column #}

        </div> {# End Main Grid #}

    </main>

    {# --- Footer --- #}
    <footer class="p-4 bg-gray-100 border-t border-gray-200 mt-auto">
        <div class="container mx-auto text-center sm:flex sm:items-center sm:justify-between">
            <div class="flex justify-center sm:justify-start items-center mb-4 sm:mb-0">
                 <a href="https://www.genomicepidemiology.org/" class="flex items-center" target="_blank" rel="noopener noreferrer">
                     <img class="mr-3 h-8" src="{{ url_for('static', filename='DTU_Food_logo_UK_RED_SMALL.png') }}" alt="DTU Food Logo"/>
                 </a>
            </div>
            <span class="block text-sm text-gray-500 text-center">
                © {{ current_year }}
                <a href="https://www.genomicepidemiology.org/" class="hover:underline" target="_blank" rel="noopener noreferrer">Center for Genomic Epidemiology™</a>.
                All Rights Reserved. |
                <a href="https://www.genomicepidemiology.org/contact/" target="_blank" rel="noopener noreferrer" class="hover:underline">Contact</a> |
                <a href="https://www.genomicepidemiology.org/privacy-policy/" target="_blank" rel="noopener noreferrer" class="hover:underline">Privacy Policy</a>
            </span>
        </div>
    </footer>

    {# Chart.js Scripts #}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    {# <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script> #} {# Datalabels removed for simplicity #}

    {# Custom JS for Charts and Animations #}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- Animate Progress Bars ---
            const progressBars = document.querySelectorAll('[data-target-width]');
            // Use a short delay to ensure transition is applied after initial render
            setTimeout(() => {
                progressBars.forEach(bar => {
                    const targetWidth = bar.getAttribute('data-target-width');
                    bar.style.width = targetWidth;
                });
            }, 100); // 100ms delay

            // --- Antibiotic Class Pie Chart ---
            const ctxAntibiotic = document.getElementById('antibioticClassChart');
            {% if antibiotic_chart_data and antibiotic_chart_data.labels %}
                // Use |tojson|safe to correctly embed JSON data into JavaScript
                const antibioticLabels = {{ antibiotic_chart_data.labels | tojson | safe }};
                const antibioticDataPoints = {{ antibiotic_chart_data.data | tojson | safe }};
                const antibioticColors = {{ antibiotic_chart_data.colors | tojson | safe }}; // Get colors from Flask

                if (ctxAntibiotic) {
                    try {
                        new Chart(ctxAntibiotic, {
                            type: 'pie',
                            data: {
                                labels: antibioticLabels,
                                datasets: [{
                                    label: 'PanGenes',
                                    data: antibioticDataPoints,
                                    backgroundColor: antibioticColors, // Use generated colors
                                    borderColor: '#fff', // White border for segments
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false, // Allow chart to fill container height
                                plugins: {
                                    legend: {
                                        position: 'bottom', // Move legend below
                                        labels: {
                                            boxWidth: 12,
                                            padding: 15,
                                            font: { size: 10 }
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                let label = context.label || '';
                                                if (label) {
                                                    label += ': ';
                                                }
                                                if (context.parsed !== null) {
                                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                    const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                                                    label += `${context.raw.toLocaleString()} (${percentage}%)`;
                                                }
                                                return label;
                                            }
                                        }
                                    },
                                    // Datalabels plugin configuration (removed for simplicity)
                                    // datalabels: {
                                    //     formatter: (value, ctx) => {
                                    //         let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    //         let percentage = (value*100 / sum).toFixed(1)+"%";
                                    //         return percentage;
                                    //     },
                                    //     color: '#fff',
                                    // }
                                },
                                onClick: (event, elements) => {
                                    if (elements.length > 0) {
                                        const chartElement = elements[0];
                                        const index = chartElement.index;
                                        const label = antibioticLabels[index];
                                        if (label) {
                                            // Link to the list page, filtered by this class
                                            // Ensure the label is URL-encoded correctly
                                            const encodedLabel = encodeURIComponent(label);
                                            const relatedUrl = `/list/related/has_resistance_class/${encodedLabel}`;
                                            window.location.href = relatedUrl;
                                        }
                                    }
                                }
                            }
                            // Register plugin if using datalabels
                            // plugins: [ChartDataLabels],
                        });
                    } catch (e) {
                        console.error("Error initializing Antibiotic Class Chart:", e);
                        // Display error message using Tailwind classes
                        const errorContainer = ctxAntibiotic.parentElement;
                        if (errorContainer) {
                            errorContainer.innerHTML = '<p class="text-red-600 text-center italic py-4">Error loading chart.</p>';
                        }
                    }
                } else {
                     console.warn("Canvas element #antibioticClassChart not found.");
                }
            {% else %}
                 // console.info("No data available for Antibiotic Class Chart."); // Handled by HTML conditional
            {% endif %}
        });
    </script>

</body>
</html> 