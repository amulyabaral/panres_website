{% extends "base.html" %}

{% block title %}Welcome - PanRes Database Explorer{% endblock %}

{% block content %}
    <h2>Welcome to the PanRes Database Explorer!</h2>
    <p>
        The <strong>PanRes database</strong> aggregates antimicrobial resistance genes (ARGs)
        from various established collections (ResFinder, CARD, MegaRes, AMRFinderPlus, etc.)
        to facilitate large-scale analysis. Each unique sequence is assigned a <code>pan_</code> identifier.
        Browse genes, origins, resistance classes, and phenotypes.
    </p>
    {# Removed the longer description and citation for brevity, add back if desired #}
    {# <p>
        It integrates data from sources like:
        ResFinder, ResFinderFG, CARD, MegaRes, AMRFinderPlus, ARGANNOT, the 'CsabaPal' collection, and BacMet.
        This explorer allows you to browse the genes, their origins, associated resistance classes,
        predicted phenotypes, and other relationships defined within the underlying data model.
    </p>
    <p>
        (Based on the work: <i>"ARGfinder - a pipeline for large-scale analysis of antimicrobial resistance genes and their flanking regions in metagenomic datasets" (Unpublished, submitted)</i>).
    </p> #}

    {# --- Source Database Visualization --- #}
    {% if source_db_counts %}
    <div class="visualization-section">
        <h4>Gene Counts by Source Database</h4>
        <ul class="db-barplot-container">
            {% for row in source_db_counts %}
            <li class="db-barplot-item">
                <span class="db-barplot-label" title="{{ row.database_name }}">{{ row.database_name }}</span>
                <div class="db-barplot-bar-wrapper">
                    {# Calculate percentage width for the bar #}
                    {% set bar_width = (row.gene_count / max_db_count * 100) | round(2) %}
                    {# Apply width inline for CSS animation target #}
                    {# Add a minimum width for visibility of small bars #}
                    <div class="db-barplot-bar" style="width: {{ [bar_width, 1] | max }}%;" title="{{ "{:,}".format(row.gene_count) }} genes">
                         {# Only show count if bar is wide enough #}
                         {% if bar_width > 10 %}
                            <span>{{ "{:,}".format(row.gene_count) }}</span>
                         {% endif %}
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
        {# Simple script to trigger animation - place in base.html or separate JS file is better #}
        <script>
          document.addEventListener('DOMContentLoaded', () => {
            // Small delay to ensure styles are applied
            setTimeout(() => {
                const bars = document.querySelectorAll('.db-barplot-bar');
                bars.forEach(bar => {
                const targetWidth = bar.style.width; // Get width set inline
                if (targetWidth) { // Ensure width is set
                    bar.style.width = '0'; // Reset to 0
                    // Trigger reflow to restart animation if needed
                    void bar.offsetWidth;
                    // Apply target width to start animation
                    bar.style.transition = 'width 1s ease-out'; // Ensure transition is set
                    bar.style.width = targetWidth;
                }
                });
            }, 100); // 100ms delay
          });
        </script>
    </div>
    {% endif %}

    {# --- Antibiotic Class Visualization Placeholder --- #}
    {% if antibiotic_class_counts %}
    <div class="visualization-section">
        <h4>Gene Counts by Antibiotic Class</h4>
        <div class="chart-container"> {# Use a container for sizing #}
            <p>Distribution of genes across {{ antibiotic_class_counts|length }} classes.</p>
            {# --- Canvas for Chart.js --- #}
            <canvas id="antibioticClassChart"></canvas>
            {# --- REMOVE Fallback List --- #}
            {# <p><i>(Visualization placeholder - showing data as list)</i></p>
            <ul class="class-data-list">
                {% for row in antibiotic_class_counts %}
                    <li><code>{{ row.class_name }}</code>: {{ "{:,}".format(row.gene_count) }}</li>
                {% endfor %}
            </ul> #}
        </div>
        {# --- Data and Script for JS Chart --- #}
        <script>
            {# Ensure ChartDataLabels plugin is registered #}
            Chart.register(ChartDataLabels);

            {# Add |safe filter to ensure JSON is rendered correctly for JS #}
            const rawClassData = {{ antibiotic_class_counts | list | tojson | safe }};
            // Prepare data for Chart.js
            const classLabels = rawClassData.map(item => item.class_name);
            const classData = rawClassData.map(item => item.gene_count);

            // Define a larger set of pastel colors
            const pastelColors = [
                '#a5d8ff', '#b2f2bb', '#ffec99', '#d0bfff', '#ffc9c9', '#a3e1d4',
                '#ffd8a8', '#d4f8d4', '#dbe4ff', '#a0e9e5', '#ffb3ba', '#bae1ff',
                '#baffc9', '#ffffba', '#f1cbff', '#ffdfba', '#ace5ee', '#e0b0ff',
                '#c1f0f6', '#f0c1f6', '#f6f0c1', '#c1f6e4', '#c1d4f6', '#f6c1c1',
                '#c1e4f6', '#e4c1f6', '#f6e4c1', '#c1f6c1', '#d4c1f6', '#f6c1d4',
                '#c1f6f0', '#f0f6c1', '#c1f6d4', '#d4f6c1', '#f6d4c1', '#c1d4f6',
                '#d4c1f6', '#f6c1d4', '#c1f6e4', '#e4f6c1', '#f6e4c1', '#c1e4f6',
                '#e4c1f6', '#f6c1e4' // Add more colors if needed
            ];

            // Ensure enough colors for the data, repeat if necessary
            const backgroundColors = classData.map((_, index) => pastelColors[index % pastelColors.length]);

            const ctxClass = document.getElementById('antibioticClassChart').getContext('2d');
            const antibioticClassChart = new Chart(ctxClass, {
                type: 'doughnut',
                data: {
                    labels: classLabels,
                    datasets: [{
                        label: 'Gene Count',
                        data: classData,
                        backgroundColor: backgroundColors,
                        borderColor: '#ffffff', // White border between segments
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Allow container to control aspect ratio
                    cutout: '50%', // Adjust donut hole size
                    plugins: {
                        legend: {
                            display: false // Hide legend as labels are shown directly
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        // Format number with commas
                                        label += context.parsed.toLocaleString();
                                    }
                                    return label;
                                }
                            }
                        },
                        datalabels: {
                            display: true,
                            anchor: 'end', // Position label anchor at the outer edge
                            align: 'start', // Align text start relative to anchor
                            offset: 10, // Distance from the chart edge
                            color: '#333', // Label text color
                            font: {
                                size: 10, // Adjust font size as needed
                                family: 'var(--font-mono)' // Use mono font
                            },
                            formatter: (value, context) => {
                                // Show label and value (or percentage)
                                const label = context.chart.data.labels[context.dataIndex];
                                // Optional: Calculate percentage
                                // const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                // const percentage = ((value / total) * 100).toFixed(1) + '%';
                                // return `${label} (${percentage})`;
                                return label; // Just show the label name outside
                            },
                            // Optional: Add background/border to labels if needed for clarity
                            // backgroundColor: 'rgba(255, 255, 255, 0.7)',
                            // borderRadius: 4,
                            // padding: 3,
                        }
                    }
                }
            });
        </script>
    </div>
    {% endif %}


    <h3>Browse Categories</h3>
    <p>Select a category below to view the items or concepts within it:</p>

    <div class="category-grid">
        {# Check if category_data exists and is not empty #}
        {% if category_data %}
            {% for display_name, data in category_data.items() %}
            <div class="category-card">
                {# Card content wrapper #}
                <div>
                    <h4>{{ display_name }}</h4>
                     {% if data.config.description %}
                        <p class="category-description">{{ data.config.description }}</p> {# Add description #}
                     {% endif %}
                    {# --- Count Removed from direct display --- #}
                    {# <p class="count"> ... </p> #}
                </div>
                {# Button links to the generic list_items route, passing the display_name as the key #}
                <a href="{{ url_for('list_items', category_key=display_name) }}" class="button">
                    Browse
                    {# Optionally add count back to button or as small text #}
                    {% if data.count is number and data.count > 0 %}
                       ({{ "{:,}".format(data.count) }})
                    {% elif data.count is string %}
                        (!) {# Indicate error #}
                    {% endif %}
                </a>
            </div>
            {% endfor %}
        {% else %}
            <p>No browseable categories defined or found. Check application configuration.</p>
        {% endif %}
    </div>

{% endblock %} 