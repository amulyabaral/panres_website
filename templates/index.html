{% extends "base.html" %}

{% block title %}Welcome - PanRes Database Explorer{% endblock %}

{# Override header content block for index page #}
{% block header_content %}
    <h2>Welcome to the PanRes Database Explorer!</h2>
    <p>
        The <strong>PanRes database</strong> aggregates antimicrobial resistance genes (ARGs)
        from various established collections (ResFinder, CARD, MegaRes, AMRFinderPlus, etc.)
        to facilitate large-scale analysis. Each unique sequence is assigned a <code>pan_</code> identifier.
        Browse genes, origins, resistance classes, and phenotypes.
    </p>
{% endblock %}

{% block content %}
    {# --- Citation Section --- #}
    <div class="citation-section">
        <h4>Please Cite:</h4>
        <p>
            Hannah-Marie Martiny, Nikiforos Pyrounakis, Thomas N Petersen, Oksana Lukjančenko, Frank M Aarestrup, Philip T L C Clausen, Patrick Munk, ARGprofiler—a pipeline for large-scale analysis of antimicrobial resistance genes and their flanking regions in metagenomic datasets, <i>Bioinformatics</i>, Volume 40, Issue 3, March 2024, btae086, <a href="https://doi.org/10.1093/bioinformatics/btae086" target="_blank" rel="noopener noreferrer">https://doi.org/10.1093/bioinformatics/btae086</a>
        </p>
    </div>

    {# --- Source Database Visualization --- #}
    {% if source_db_counts %}
    <div class="visualization-section">
        <h4>PanRes Data Sources</h4>
        <ul class="db-barplot-container">
            {# Calculate total ONLY from the sources being displayed #}
            {% set total_source_genes = source_db_counts | sum(attribute='gene_count') %}
            {% for row in source_db_counts %}
            {# Calculate width relative to the total of displayed sources #}
            {% set bar_width = (row.gene_count / total_source_genes * 100) if total_source_genes else 0 %}
            {# Generate the link URL #}
            {% set db_link = url_for('genes_related_to', predicate='is_from_database', object_value=row.database_name) %}
            <li class="db-barplot-item">
                {# Link the label #}
                <a href="{{ db_link }}" class="db-barplot-label-link" title="{{ row.database_name }} ({{ "{:,}".format(row.gene_count) }} genes)">
                    <span class="db-barplot-label">{{ row.database_name }}</span>
                </a>
                {# Link the bar wrapper #}
                <a href="{{ db_link }}" class="db-barplot-bar-link" title="{{ row.database_name }} ({{ "{:,}".format(row.gene_count) }} genes)">
                    <div class="db-barplot-bar-wrapper">
                        {# Apply width inline. Use max(bar_width, 1) for visibility of small bars #}
                        <div class="db-barplot-bar" style="width: {{ [bar_width, 0.5] | max }}%;" title="{{ "{:,}".format(row.gene_count) }} genes">
                             {# Only show count if bar is wide enough #}
                             {% if bar_width > 10 %} {# Adjust threshold as needed #}
                                <span style="padding: 0 0.5em;">{{ "{:,}".format(row.gene_count) }}</span>
                             {% endif %}
                        </div>
                    </div>
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    {# --- NEW: Antibiotic Class Buttons Section --- #}
    {% if antibiotic_class_counts %}
    <div class="visualization-section antibiotic-classes-buttons">
        <h4>PanRes 2.0 has resistance genes from following classes:</h4>
        <div class="class-buttons-container">
            {% for row in antibiotic_class_counts %}
                {% set class_link = url_for('genes_related_to', predicate='has_resistance_class', object_value=row.class_name) %}
                <a href="{{ class_link }}" class="button class-button" title="View genes for {{ row.class_name }}">
                    {{ row.class_name }}
                    {# Span to hold the animated count #}
                    (<span class="count-number" data-count="{{ row.gene_count }}">0</span>)
                </a>
            {% endfor %}
        </div>
    </div>
    {% else %}
        <div class="visualization-section">
             <h4>Antibiotic Classes</h4>
             <p>No data available to display antibiotic class counts.</p>
        </div>
    {% endif %}
    {# --- End Antibiotic Class Buttons Section --- #}


    <h3>Browse Categories</h3>
    <p>Select a category below to view the items or concepts within it:</p>

    <div class="category-grid">
        {# Check if category_data exists and is not empty #}
        {% if category_data %}
            {% for display_name, data in category_data.items() %}
            <div class="category-card">
                {# Card content wrapper #}
                <div>
                    <h4>{{ display_name }}</h4>
                     {% if data.config.description %}
                        <p class="category-description">{{ data.config.description }}</p> {# Add description #}
                     {% endif %}
                    {# --- Count Removed from direct display --- #}
                    {# <p class="count"> ... </p> #}
                </div>
                {# Button links to the generic list_items route, passing the display_name as the key #}
                <a href="{{ url_for('list_items', category_key=display_name) }}" class="button">
                    Browse
                    {# Optionally add count back to button or as small text #}
                    {% if data.count is number and data.count > 0 %}
                       ({{ "{:,}".format(data.count) }})
                    {% elif data.count is string %}
                        (!) {# Indicate error #}
                    {% endif %}
                </a>
            </div>
            {% endfor %}
        {% else %}
            <p>No browseable categories defined or found. Check application configuration.</p>
        {% endif %}
    </div>

    {# --- NEW: JavaScript for Count Animation --- #}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const counters = document.querySelectorAll('.count-number');
            const animationDuration = 1000; // Duration in milliseconds (e.g., 1 second)

            counters.forEach(counter => {
                const targetCount = parseInt(counter.dataset.count, 10);
                let currentCount = 0;
                const increment = targetCount / (animationDuration / 16); // Calculate increment per frame (approx 60fps)

                const updateCount = () => {
                    currentCount += increment;
                    if (currentCount < targetCount) {
                        // Format with commas while animating
                        counter.textContent = Math.ceil(currentCount).toLocaleString();
                        requestAnimationFrame(updateCount);
                    } else {
                        // Ensure final count is exact and formatted
                        counter.textContent = targetCount.toLocaleString();
                    }
                };

                // Start the animation
                requestAnimationFrame(updateCount);
            });
        });
    </script>
    {# --- End JavaScript for Count Animation --- #}

{% endblock %} 