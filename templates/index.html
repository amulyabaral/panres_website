{% extends "base.html" %}

{% block title %}{{ site_name }} - Home{% endblock %}

{% block content %}

    {# *** START ERROR DISPLAY BLOCK *** #}
    {% if show_error %}
    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-md shadow-md" role="alert">
        <p class="font-bold">Error {{ error_code }}</p>
        <p>{{ error_message | default('An unexpected error occurred.', true) }}</p>
        <p class="mt-2 text-sm">You can try returning to the <a href="{{ url_for('index') }}" class="font-medium hover:underline">Homepage</a>.</p>
    </div>
    {% endif %}
    {# *** END ERROR DISPLAY BLOCK *** #}

    {# --- Show content only if NOT showing an error --- #}
    {% if not show_error %}

    {# --- Combined Intro, Search, and Browse Section --- #}
    <section class="mb-12 bg-white p-6 rounded-lg shadow-md border border-gray-200">
        <h2 class="text-3xl font-semibold text-gray-800 mb-3">{{ site_name }}</h2>
        <p class="text-gray-600 text-sm mb-4">
            PanRes (Pan Resistance) is a curated collection of genes conferring resistance to antibiotics, heavy metals, and biocides.
            We have aggregated unique gene sequences from multiple databases like ResFinder, CARD, MegaRes, AMRFinderPlus, ARGANNOT, BacMet,
            and functionally verified genes and unified the ontology.
        </p>

        {# Container for Search #}
        <div class="mb-4"> {# Added margin-bottom #}
            {# Search Form - Autocomplete handled by JS, no action needed #}
            {# Added relative positioning for suggestions dropdown #}
            {# Added onsubmit="return false;" to prevent default submission #}
            <form method="get" class="flex-grow flex items-center gap-0 relative" onsubmit="return false;">
                <label for="search-term" class="sr-only">Search Term</label>
                {# Added autocomplete="off" and event listeners for suggestions #}
                <input type="search" id="search-term" name="q" placeholder="Search genes, classes, phenotypes..."
                       class="flex-grow px-4 py-2 border border-gray-300 rounded-l-md focus:ring-dtu-red focus:border-dtu-red focus:z-10"
                       required autocomplete="off"
                       oninput="getSuggestions(this.value)"
                       onblur="hideSuggestionsDebounced()"
                       aria-haspopup="listbox" {# Accessibility improvement #}
                       aria-controls="suggestions">
                {# Search button can be kept for visual cue or removed if desired #}
                <button type="button" class="inline-flex items-center bg-dtu-red text-white px-4 py-2 rounded-r-md text-sm font-medium border border-dtu-red -ml-px cursor-default"> {# Changed type to button, removed hover effect #}
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"> <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /> </svg>
                    <span class="sr-only">Search</span>
                </button>
                {# Container for suggestions dropdown #}
                {# Added role="listbox" for accessibility #}
                <div id="suggestions" role="listbox"
                     class="absolute left-0 right-0 top-full mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg z-20 hidden overflow-y-auto max-h-60">
                    <!-- Suggestions will be loaded here by JavaScript -->
                </div>
            </form>
        </div>

        {# MOVED descriptive paragraph here #}
        <p class="text-gray-600 text-sm mb-6">
            Find detailed information about each PanRes gene: browse antibiotic classes, predicted antibiotic resistance phenotype(s) and ontology across different resources.
        </p>

        {# MOVED Browse Buttons and GitHub Link here #}
        <div class="flex flex-wrap justify-center md:justify-start items-center gap-2 flex-shrink-0"> {# Added flex-shrink-0 #}
            <a href="{{ url_for('list_items', category_key='Antibiotic Classes') }}" class="inline-block bg-dtu-red hover:bg-opacity-80 text-white px-3 py-2 rounded text-xs font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-dtu-red focus:ring-offset-2 whitespace-nowrap">Browse Class</a>
            <a href="{{ url_for('list_items', category_key='Source Databases') }}" class="inline-block bg-dtu-red hover:bg-opacity-80 text-white px-3 py-2 rounded text-xs font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-dtu-red focus:ring-offset-2 whitespace-nowrap">Browse Source</a>
            <a href="{{ url_for('list_items', category_key='Predicted Phenotypes') }}" class="inline-block bg-dtu-red hover:bg-opacity-80 text-white px-3 py-2 rounded text-xs font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-dtu-red focus:ring-offset-2 whitespace-nowrap">Browse Phenotype</a>
            <a href="https://github.com/genomicepidemiology/PanResOntology" target="_blank" rel="noopener noreferrer" class="inline-flex items-center text-gray-600 hover:text-dtu-red transition-colors duration-200 px-2 py-2" title="View on GitHub">
                <i class="fab fa-github fa-lg"></i>
                <span class="sr-only">GitHub Repo</span>
            </a>
        </div>
    </section>

    {# --- Charts Section (Combined Card) --- #}
    {# Add an id for the anchor link from the button above #}
    <section id="charts" class="mb-12">
        {# Updated Section Title #}
        <h3 class="text-2xl font-semibold text-gray-700 mb-6 text-center">PanRes by the numbers</h3>

        {# Single Card Container for all charts #}
        {# Add data attributes to hold the JSON configuration #}
        <div id="chart-data-container"
             data-antibiotic="{{ antibiotic | tojson | safe if antibiotic else 'null' }}"
             data-source-db="{{ source_db | tojson | safe if source_db else 'null' }}"
             data-phenotype="{{ phenotype | tojson | safe if phenotype else 'null' }}"
             class="bg-white p-4 md:p-6 rounded-lg shadow-md border border-gray-200">

            {# Grid for top two charts (Pie and Donut) #}
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8 mb-6 lg:mb-8">

                {# Antibiotic Classes Chart Card (Pie) #}
                <div class="flex flex-col"> {# Removed card styling, just a container #}
                    <h4 class="text-lg font-semibold text-gray-700 mb-2 text-center">Top Antibiotic Resistance Classes</h4>
                    <p class="text-gray-600 text-sm mb-4 text-center">Distribution across top 7 classes + Others</p>
                    {# Check if the data attribute exists and is not 'null' before creating canvas #}
                    {% if antibiotic %}
                        <div class="relative h-64 md:h-80 mx-auto w-full max-w-sm mb-4">
                            <canvas id="antibiotic"></canvas> {# Canvas ID matches JS #}
                        </div>
                        {# Button #}
                        <div class="mt-auto text-center">
                            <a href="{{ url_for('list_items', category_key='Antibiotic Classes') }}"
                               class="inline-block bg-dtu-red hover:bg-opacity-80 text-white px-4 py-2 rounded text-sm font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-dtu-red focus:ring-offset-2">
                                Browse by Class
                            </a>
                        </div>
                    {% else %}
                        <p class="text-gray-500 italic text-center py-4">No data available for antibiotic classes chart.</p>
                    {% endif %}
                </div>

                {# Source Databases Chart Card (Donut) #}
                <div class="flex flex-col"> {# Removed card styling, just a container #}
                    <h4 class="text-lg font-semibold text-gray-700 mb-2 text-center">Genes by Source Database</h4>
                    <p class="text-gray-600 text-sm mb-4 text-center">Relative contribution from source databases</p>
                    {# Check if the data attribute exists and is not 'null' before creating canvas #}
                    {% if source_db %}
                        <div class="relative h-64 md:h-80 mx-auto w-full max-w-sm mb-4"> {# Adjusted max-width like pie #}
                            <canvas id="sourceDb"></canvas> {# Canvas ID matches JS #}
                        </div>
                        {# Button #}
                        <div class="mt-auto text-center">
                            <a href="{{ url_for('list_items', category_key='Source Databases') }}"
                               class="inline-block bg-dtu-red hover:bg-opacity-80 text-white px-4 py-2 rounded text-sm font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-dtu-red focus:ring-offset-2">
                                Browse by Source
                            </a>
                        </div>
                    {% else %}
                        <p class="text-gray-500 italic text-center py-4">No data available for source databases chart.</p>
                    {% endif %}
                </div>
            </div> {# End of grid for top two charts #}

            {# Divider (Optional) #}
            <hr class="my-4 md:my-6 border-gray-200">

            {# Container for the bottom chart (Phenotype Stacked Bar) #}
            <div class="flex flex-col"> {# Removed card styling, just a container #}
                 <h4 class="text-lg font-semibold text-gray-700 mb-2 text-center">Predicted Phenotype Proportions</h4>
                 <p class="text-gray-600 text-sm mb-4 text-center">Relative distribution of phenotypes across PanGenes</p>
                 {# Check if the data attribute exists and is not 'null' before creating canvas #}
                 {% if phenotype %}
                     <div class="relative h-20 md:h-24 w-full mx-auto mb-4">
                         <canvas id="phenotype"></canvas> {# Canvas ID matches JS #}
                     </div>
                     {# Button #}
                     <div class="mt-auto text-center">
                         <a href="{{ url_for('list_items', category_key='Predicted Phenotypes') }}"
                            class="inline-block bg-dtu-red hover:bg-opacity-80 text-white px-4 py-2 rounded text-sm font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-dtu-red focus:ring-offset-2">
                                 Browse by Phenotype
                             </a>
                     </div>
                 {% else %}
                     <p class="text-gray-500 italic text-center py-4">No phenotype data available.</p>
                 {% endif %}
            </div> {# End of container for bottom chart #}

        </div> {# End of Single Card Container #}
    </section>
    {# --- END Charts Section --- #}

    {# --- Citation Section (Only show if NOT showing an error) --- #}
    <section class="bg-gray-100 p-6 rounded-lg border border-gray-200 shadow-sm">
        <h3 class="text-xl font-semibold text-gray-700 mb-3">Citation</h3>
        <p class="text-gray-600 text-sm">
            If you use the PanRes database or website, please cite:
        </p>
        <blockquote class="mt-2 text-sm text-gray-800 border-l-4 border-dtu-red pl-4 italic">
            {{ citation_text | safe }}
        </blockquote>
    </section>
    {% endif %} {# End of "if not show_error" block #}

{% endblock %}

{% block scripts %}
    {# Chart.js Scripts are now in base.html #}
    {# Custom JS for Charts #}
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM fully loaded and parsed"); // Log: Check if script starts

        const isErrorPage = document.querySelector('.bg-red-100[role="alert"]');
        if (isErrorPage) {
            console.log("Error page detected, skipping chart initialization.");
            return; // Skip chart and suggestion setup on error pages
        }
        console.log("Not an error page, proceeding with chart setup."); // Log: Check if proceeding

        // Register the datalabels plugin globally
        if (typeof ChartDataLabels !== 'undefined') {
            console.log("ChartDataLabels plugin found, registering."); // Log: Check plugin
            Chart.register(ChartDataLabels);
        } else {
            console.warn('ChartDataLabels plugin not found. Percentages on stacked bar chart will not be displayed.');
        }

        // Get chart data container and parse data attributes
        const chartDataContainer = document.getElementById('chart-data-container');
        if (!chartDataContainer) {
            console.error("Chart data container element not found!"); // Log: Check container
            return;
        }
        console.log("Chart data container found."); // Log: Check container found

        let antibioticCfg = null; // Renamed for clarity
        let sourceDbCfg = null;   // Renamed for clarity
        let phenotypeCfg = null;  // Renamed for clarity

        try {
            const antibioticData = chartDataContainer.dataset.antibiotic;
            const sourceDbData = chartDataContainer.dataset.sourceDb;
            const phenotypeData = chartDataContainer.dataset.phenotype;

            console.log("Raw antibiotic data:", antibioticData); // Log: Raw data
            console.log("Raw sourceDb data:", sourceDbData);     // Log: Raw data
            console.log("Raw phenotype data:", phenotypeData);   // Log: Raw data

            if (antibioticData && antibioticData !== 'null') {
                antibioticCfg = JSON.parse(antibioticData);
                console.log("Parsed antibiotic config:", antibioticCfg); // Log: Parsed data
            } else {
                 console.log("No antibiotic data found or data is null.");
            }
            if (sourceDbData && sourceDbData !== 'null') {
                sourceDbCfg = JSON.parse(sourceDbData);
                console.log("Parsed sourceDb config:", sourceDbCfg); // Log: Parsed data
            } else {
                 console.log("No sourceDb data found or data is null.");
            }
            if (phenotypeData && phenotypeData !== 'null') {
                phenotypeCfg = JSON.parse(phenotypeData);
                console.log("Parsed phenotype config:", phenotypeCfg); // Log: Parsed data
            } else {
                 console.log("No phenotype data found or data is null.");
            }
        } catch (e) {
            console.error("Error parsing chart JSON data from data attributes:", e);
            return; // Stop if JSON is invalid
        }


        /* Chart helper functions */
        // Combined function for Pie and Doughnut charts
        const createPieDoughnut = (id, d, type = 'pie') => {
            console.log(`Attempting to create ${type} chart with id '${id}'`); // Log: Chart creation attempt
            const ctx = document.getElementById(id);
            if (!ctx) {
                // This log should now be redundant because of the checks below, but kept as a fallback.
                console.error(`Canvas element with id '${id}' not found for ${type} chart.`);
                return null;
            }
            console.log(`Canvas element '${id}' found.`); // Log: Canvas found
            try {
                return new Chart(ctx, {
                    type: type,
                    data: {
                        labels: d.labels,
                        datasets:[{
                            data:d.data,
                            backgroundColor:d.colors
                        }]
                    },
                    options:{
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins:{
                            legend:{ display: false },
                            datalabels: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) { label += ': '; }
                                        if (context.parsed !== null) {
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const value = context.raw;
                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            label += `${value} (${percentage}%)`;
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (chartError) {
                console.error(`Error creating chart '${id}':`, chartError); // Log: Chart.js specific error
                return null;
            }
        };

        // Function for Stacked Bar charts
        const createStackedBar = (id, d) => {
             console.log(`Attempting to create stacked bar chart with id '${id}'`); // Log: Chart creation attempt
            const ctx = document.getElementById(id);
            if (!ctx) {
                 // This log should now be redundant because of the checks below, but kept as a fallback.
                console.error(`Canvas element with id '${id}' not found for stacked bar chart.`);
                return null;
            }
             console.log(`Canvas element '${id}' found.`); // Log: Canvas found
            try {
                return new Chart(ctx, {
                    type:'bar',
                    data:{
                        labels:['Predicted Phenotypes'],
                        datasets: d.segments.map(s => ({
                            label: s.name,
                            data: [s.percentage],
                            backgroundColor: s.color,
                            count: s.count,
                            percentage: s.percentage
                        }))
                    },
                    options:{
                        indexAxis:'y',
                        responsive:true,
                        maintainAspectRatio: false,
                        scales:{
                            x:{ stacked:true, display: true, max: 100, ticks: { callback: value => value + '%' } },
                            y:{ stacked:true, display:false }
                        },
                        plugins:{
                            legend:{ display: false },
                            tooltip: {
                                callbacks: {
                                     label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) { label += ': '; }
                                        const count = context.dataset.count;
                                        const percentage = context.dataset.percentage;
                                        if (count !== undefined && percentage !== undefined) {
                                            label += `${count} (${percentage.toFixed(1)}%)`;
                                        } else {
                                            label += context.formattedValue + '%';
                                        }
                                        return label;
                                    }
                                }
                            },
                            datalabels: {
                                formatter: (value, context) => {
                                    return value > 5 ? value.toFixed(1) + '%' : '';
                                },
                                color: '#ffffff',
                                font: { weight: 'bold' }
                            }
                        }
                    }
                });
            } catch (chartError) {
                console.error(`Error creating chart '${id}':`, chartError); // Log: Chart.js specific error
                return null;
            }
        };

        // Initialize charts if data exists AND canvas elements are found
        console.log("Initializing charts..."); // Log: Start initialization

        if (antibioticCfg) {
            // Explicitly check if the canvas element exists in the DOM
            if (document.getElementById('antibiotic')) {
                 console.log("Data found and canvas '#antibiotic' exists. Attempting to create chart.");
                 createPieDoughnut('antibiotic', antibioticCfg, 'doughnut'); // Keep as doughnut
            } else {
                 /* This case means data was passed, but the {% if %} block in the template
                    didn't render the canvas (shouldn't happen if data is truthy) */
                 console.warn("Antibiotic data found, but canvas element '#antibiotic' not found in DOM. Skipping chart creation.");
            }
        } else {
            /* This case means antibioticCfg was null/undefined after parsing,
               likely because no data was passed from Flask or it was empty. */
            console.log("Skipping antibiotic chart initialization (no data parsed or data was null/empty).");
        }

        if (sourceDbCfg) {
             // Explicitly check if the canvas element exists in the DOM
            if (document.getElementById('sourceDb')) {
                 console.log("Data found and canvas '#sourceDb' exists. Attempting to create chart.");
                 createPieDoughnut('sourceDb',  sourceDbCfg, 'doughnut'); // Explicitly doughnut
            } else {
                 /* This case means data was passed, but the {% if %} block in the template
                    didn't render the canvas (shouldn't happen if data is truthy) */
                 console.warn("Source DB data found, but canvas element '#sourceDb' not found in DOM. Skipping chart creation.");
            }
        } else {
             /* This case means sourceDbCfg was null/undefined after parsing,
                likely because no data was passed from Flask or it was empty. */
             console.log("Skipping sourceDb chart initialization (no data parsed or data was null/empty).");
        }

        if (phenotypeCfg) {
             // Explicitly check if the canvas element exists in the DOM
            if (document.getElementById('phenotype')) {
                 console.log("Data found and canvas '#phenotype' exists. Attempting to create chart.");
                 createStackedBar('phenotype', phenotypeCfg);
            } else {
                 /* This case means data was passed, but the {% if %} block in the template
                    didn't render the canvas (shouldn't happen if data is truthy) */
                 console.warn("Phenotype data found, but canvas element '#phenotype' not found in DOM. Skipping chart creation.");
            }
        } else {
             /* This case means phenotypeCfg was null/undefined after parsing,
                likely because no data was passed from Flask or it was empty. */
             console.log("Skipping phenotype chart initialization (no data parsed or data was null/empty).");
        }
        console.log("Chart initialization finished."); // Log: End initialization

      }); // End DOMContentLoaded for charts

      // --- Autocomplete Suggestion Logic ---
      let suggestionTimeout; // To debounce hiding suggestions
      let fetchController; // To abort previous fetch requests

      function getSuggestions(query) {
          const suggestionsDiv = document.getElementById('suggestions');
          const searchTermInput = document.getElementById('search-term');

          // Abort any ongoing fetch request
          if (fetchController) {
              fetchController.abort();
          }

          if (query.length < 2) { // Minimum characters to trigger search
              suggestionsDiv.innerHTML = '';
              suggestionsDiv.classList.add('hidden');
              searchTermInput.removeAttribute('aria-activedescendant'); // Accessibility
              return;
          }

          // Show loading indicator (optional)
          suggestionsDiv.innerHTML = '<div class="px-4 py-2 text-sm text-gray-500">Loading...</div>';
          suggestionsDiv.classList.remove('hidden');

          // Create a new AbortController for this request
          fetchController = new AbortController();
          const signal = fetchController.signal;

          // Fetch suggestions from the backend
          fetch(`/autocomplete?q=${encodeURIComponent(query)}`, { signal })
              .then(response => {
                  if (!response.ok) {
                      throw new Error(`HTTP error! status: ${response.status}`);
                  }
                  return response.json();
               })
              .then(data => {
                  suggestionsDiv.innerHTML = ''; // Clear previous suggestions/loading
                  if (data && data.length > 0) {
                      const list = document.createElement('ul');
                      list.id = 'suggestion-list'; // ID for aria-controls
                      data.forEach((item, index) => {
                          const listItem = document.createElement('li');
                          listItem.id = `suggestion-${index}`; // Unique ID for each item
                          listItem.setAttribute('role', 'option');

                          // --- Create Indicator ---
                          let indicatorIcon = 'fa-question-circle'; // Default icon
                          let indicatorColor = 'text-gray-400';
                          let indicatorTitle = item.type_indicator || 'Other'; // Use title from backend

                          switch(item.type_indicator) {
                              case 'Gene':
                                  indicatorIcon = 'fa-dna';
                                  indicatorColor = 'text-blue-500';
                                  break;
                              case 'Class':
                                  indicatorIcon = 'fa-layer-group';
                                  indicatorColor = 'text-green-500';
                                  break;
                              case 'Phenotype':
                                  indicatorIcon = 'fa-tags';
                                  indicatorColor = 'text-purple-500';
                                  break;
                              case 'Database':
                                  indicatorIcon = 'fa-database';
                                  indicatorColor = 'text-orange-500';
                                  break;
                              case 'Ontology Class':
                                  indicatorIcon = 'fa-sitemap';
                                  indicatorColor = 'text-indigo-500';
                                  break;
                               case 'Resource':
                                  indicatorIcon = 'fa-link';
                                  indicatorColor = 'text-teal-500';
                                  break;
                          }
                          const indicatorHtml = `<i class="fas ${indicatorIcon} ${indicatorColor} mr-2 fa-fw" title="${indicatorTitle}"></i>`;
                          // --- End Indicator ---

                          // Use 'mousedown' to register click before 'blur' hides the div
                          // Use an inner link for navigation
                          listItem.innerHTML = `<a href="${item.link}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-dtu-red flex items-center suggestion-link">
                                                    ${indicatorHtml}
                                                    <span class="flex-grow">${item.display_name}</span>
                                                    <span class="text-xs text-gray-500 ml-2">(${item.id})</span>
                                                </a>`;
                          // Prevent blur when clicking suggestion link
                          listItem.addEventListener('mousedown', (e) => {
                              // Allow middle-click/ctrl-click to open in new tab
                              if (e.button === 0 && !e.ctrlKey && !e.metaKey) {
                                  window.location.href = item.link;
                              }
                          });
                          list.appendChild(listItem);
                      });
                      suggestionsDiv.appendChild(list);
                      suggestionsDiv.classList.remove('hidden');
                  } else {
                      // Show "No results" message
                      suggestionsDiv.innerHTML = '<div class="px-4 py-2 text-sm text-gray-500">No results found.</div>';
                      suggestionsDiv.classList.remove('hidden'); // Keep div visible to show message
                      searchTermInput.removeAttribute('aria-activedescendant');
                  }
              })
              .catch(error => {
                  if (error.name === 'AbortError') {
                      console.log('Fetch aborted'); // Expected when typing quickly
                  } else {
                      console.error('Error fetching suggestions:', error);
                      suggestionsDiv.innerHTML = '<div class="px-4 py-2 text-sm text-red-600">Error loading suggestions.</div>';
                      suggestionsDiv.classList.remove('hidden'); // Show error
                      searchTermInput.removeAttribute('aria-activedescendant');
                  }
              })
              .finally(() => {
                  // Clear the controller when fetch is done or aborted
                  fetchController = null;
              });
      }

      function hideSuggestions() {
          const suggestionsDiv = document.getElementById('suggestions');
          const searchTermInput = document.getElementById('search-term');
          suggestionsDiv.classList.add('hidden');
          suggestionsDiv.innerHTML = ''; // Clear content when hiding
          searchTermInput.removeAttribute('aria-activedescendant');
      }

      // Debounce hiding to allow clicking on suggestions
      function hideSuggestionsDebounced() {
          clearTimeout(suggestionTimeout);
          suggestionTimeout = setTimeout(hideSuggestions, 200); // Increased delay slightly
      }

      // --- Keyboard Navigation for Suggestions (Optional but recommended for accessibility) ---
      const searchTermInput = document.getElementById('search-term');
      const suggestionsDiv = document.getElementById('suggestions');
      let activeSuggestionIndex = -1;

      searchTermInput.addEventListener('keydown', (e) => {
          const suggestionList = suggestionsDiv.querySelector('#suggestion-list');
          if (!suggestionList || suggestionsDiv.classList.contains('hidden')) {
              activeSuggestionIndex = -1;
              return;
          }

          const items = suggestionList.querySelectorAll('li[role="option"]');
          if (!items.length) return;

          if (e.key === 'ArrowDown') {
              e.preventDefault(); // Prevent cursor move in input
              activeSuggestionIndex++;
              if (activeSuggestionIndex >= items.length) activeSuggestionIndex = 0;
              updateActiveSuggestion(items);
          } else if (e.key === 'ArrowUp') {
              e.preventDefault(); // Prevent cursor move in input
              activeSuggestionIndex--;
              if (activeSuggestionIndex < 0) activeSuggestionIndex = items.length - 1;
              updateActiveSuggestion(items);
          } else if (e.key === 'Enter') {
              if (activeSuggestionIndex >= 0 && activeSuggestionIndex < items.length) {
                  e.preventDefault(); // Prevent form submission
                  const activeLink = items[activeSuggestionIndex].querySelector('a.suggestion-link');
                  if (activeLink) {
                      activeLink.click(); // Simulate click or navigate directly
                      // window.location.href = activeLink.href; // Alternative navigation
                  }
              }
              // Allow default form submission if Enter is pressed without an active suggestion?
              // Currently form submission is prevented by onsubmit="return false;"
          } else if (e.key === 'Escape') {
              hideSuggestions();
          }
      });

      function updateActiveSuggestion(items) {
          items.forEach((item, index) => {
              const link = item.querySelector('a.suggestion-link');
              if (index === activeSuggestionIndex) {
                  item.classList.add('bg-gray-100'); // Highlight active item
                  link?.classList.add('text-dtu-red');
                  searchTermInput.setAttribute('aria-activedescendant', item.id);
                  item.scrollIntoView({ block: 'nearest' }); // Ensure visible
              } else {
                  item.classList.remove('bg-gray-100');
                  link?.classList.remove('text-dtu-red');
              }
          });
      }

      // Optional: Hide suggestions if clicked outside the search input and suggestions list
      document.addEventListener('click', function(event) {
          const searchForm = searchTermInput.closest('form');
          if (searchForm && !searchForm.contains(event.target)) {
              // Check if the click was outside the form (input + suggestions div)
              hideSuggestions();
          }
      });

    </script>
{% endblock %} 