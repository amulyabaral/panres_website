{% extends "base.html" %}

{% block title %}{{ site_name }} - Home{% endblock %}

{% block content %}

    {# *** START ERROR DISPLAY BLOCK *** #}
    {% if show_error %}
    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-md shadow-md" role="alert">
        <p class="font-bold">Error {{ error_code }}</p>
        <p>{{ error_message | default('An unexpected error occurred.', true) }}</p>
        <p class="mt-2 text-sm">You can try returning to the <a href="{{ url_for('index') }}" class="font-medium hover:underline">Homepage</a>.</p>
    </div>
    {% endif %}
    {# *** END ERROR DISPLAY BLOCK *** #}

    {# --- Show content only if NOT showing an error --- #}
    {% if not show_error %}

    {# --- About PanRes Section --- #}
    <section class="mb-12">
        <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
            <h2 class="text-3xl font-semibold text-gray-800 mb-3">{{ site_name }}</h2>
            <p class="text-gray-600 text-sm">
                PanRes (Pan Resistance) is a unified collection of genes conferring resistance to antibiotics, heavy metals, and biocides.
                It aggregates unique gene sequences from established databases like ResFinder, CARD, MegaRes, AMRFinderPlus, ARGANNOT, BacMet,
                and functionally verified genes from recent studies.
            </p>
        </div>
    </section>

    {# --- Browse Categories Section --- #}
    <section class="mb-12">
        <h3 class="text-2xl font-semibold text-gray-700 mb-6 text-center">Browse Data</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            {# Standard Card Style #}
            {# Loop through the configuration dict #}
            {% for key, info in index_categories.items() %}
            {# Card uses standard utilities already, but ensure button uses utilities now #}
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 hover:shadow-lg transition-shadow duration-200 flex flex-col">
                <h4 class="text-xl font-semibold text-dtu-red mb-2">{{ key }}</h4>
                <p class="text-gray-600 text-sm mb-4 flex-grow">{{ info.description }}</p>
                <div class="text-sm text-gray-500 mb-4">
                    {# Access the count from the category_counts dict using the key #}
                    <span class="font-medium">{{ category_counts.get(key, 'N/A') }}</span> items
                </div>
                {# Apply button utilities directly instead of .btn #}
                <a href="{{ url_for('list_items', category_key=key) }}"
                   class="mt-auto inline-block bg-dtu-red hover:bg-opacity-80 text-white px-4 py-2 rounded text-sm font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-dtu-red focus:ring-offset-2 text-center">
                    View {{ key }}
                </a>
            </div>
            {% else %}
            <p class="text-gray-500 italic md:col-span-2 lg:col-span-4 text-center">No categories found.</p>
            {% endfor %}
        </div>
    </section>

    {# --- Charts Section (Only show if NOT showing an error) --- #}
    <section class="mb-12">
        {# Changed title text #}
        <h3 class="text-2xl font-semibold text-gray-700 mb-6 text-center">Here's an overview of what you'll find in PanRes 2.0</h3>

        {# Grid for top two charts (Pie and Bar) #}
        {# Kept lg:grid-cols-2 and gap-8 #}
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            {# Antibiotic Classes Chart Card (Pie) #}
            {# Apply card utilities directly instead of .chart-card #}
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 flex flex-col">
                <h4 class="text-lg font-semibold text-gray-700 mb-4 text-center">Genes per Antibiotic Class</h4>
                <p class="text-gray-600 text-sm mb-4 text-center">Distribution of PanRes genes across different antibiotic resistance classes</p>
                {% if antibiotic and antibiotic.data %}
                    {# Apply chart container utilities directly #}
                    <div class="relative h-80 md:h-96 mx-auto max-w-full mb-4">
                        <canvas id="antibiotic"></canvas>
                    </div>
                    {# Apply button utilities directly #}
                    <div class="mt-auto text-center">
                        <a href="{{ url_for('list_items', category_key='Antibiotic Classes') }}"
                           class="inline-block bg-dtu-red hover:bg-opacity-80 text-white px-4 py-2 rounded text-sm font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-dtu-red focus:ring-offset-2">
                            Browse by Antibiotic Class
                        </a>
                    </div>
                {% else %}
                    <p class="text-gray-500 italic text-center py-4">No data available for antibiotic classes chart.</p>
                {% endif %}
            </div>

            {# Source Databases Chart Card (Bar) #}
            {# Apply card utilities directly instead of .chart-card #}
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 flex flex-col">
                <h4 class="text-lg font-semibold text-gray-700 mb-4 text-center">Genes per Source Database</h4>
                <p class="text-gray-600 text-sm mb-4 text-center">Number of genes contributed by each source database to the PanRes collection</p>
                {% if source_db and source_db.segments %}
                    {# Apply chart container utilities directly #}
                    <div class="relative h-80 md:h-96 mx-auto max-w-full mb-4">
                        <canvas id="sourceDb"></canvas>
                    </div>
                    {# Apply button utilities directly #}
                    <div class="mt-auto text-center">
                        <a href="{{ url_for('list_items', category_key='Source Databases') }}"
                           class="inline-block bg-dtu-red hover:bg-opacity-80 text-white px-4 py-2 rounded text-sm font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-dtu-red focus:ring-offset-2">
                            Browse by Source Database
                        </a>
                    </div>
                {% else %}
                    <p class="text-gray-500 italic text-center py-4">No data available for source databases chart.</p>
                {% endif %}
            </div>
        </div> {# End of grid for top two charts #}

        {# Container for the bottom chart (Phenotype Stacked Bar) #}
        {# Kept flex container to center the card #}
        <div class="flex justify-center">
            {# Apply card utilities directly instead of .chart-card #}
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 flex flex-col w-full lg:max-w-xl">
                <h4 class="text-lg font-semibold text-gray-700 mb-4 text-center">Predicted Phenotype Proportions</h4>
                <p class="text-gray-600 text-sm mb-4 text-center">Relative distribution of phenotypes across PanGenes</p>
                {% if phenotype and phenotype.segments %}
                    {# Apply chart container utilities directly #}
                    <div class="relative h-80 md:h-96 mx-auto max-w-full mb-4">
                        <canvas id="phenotype"></canvas>
                    </div>
                    {# Apply button utilities directly #}
                    <div class="mt-auto text-center">
                        <a href="{{ url_for('list_items', category_key='Predicted Phenotypes') }}"
                           class="inline-block bg-dtu-red hover:bg-opacity-80 text-white px-4 py-2 rounded text-sm font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-dtu-red focus:ring-offset-2">
                            Browse by Predicted Phenotype
                        </a>
                    </div>
                {% else %}
                    <p class="text-gray-500 italic text-center py-4">No phenotype data available.</p>
                {% endif %}
            </div>
        </div> {# End of container for bottom chart #}
    </section>

    {# --- Citation Section (Only show if NOT showing an error) --- #}
    <section class="bg-gray-100 p-6 rounded-lg border border-gray-200 shadow-sm">
        <h3 class="text-xl font-semibold text-gray-700 mb-3">Citation</h3>
        <p class="text-gray-600 text-sm">
            If you use the PanRes database or website, please cite:
        </p>
        <blockquote class="mt-2 text-sm text-gray-800 border-l-4 border-dtu-red pl-4 italic">
            {{ citation_text | safe }}
        </blockquote>
    </section>
    {% endif %} {# End of "if not show_error" block #}

{% endblock %}

{% block scripts %}
    {# Chart.js Scripts #}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    {# <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script> #}

    {# Custom JS for Charts #}
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Check if we are showing an error message (rendered by error handlers)
        // If so, the chart data might not be available or relevant.
        const isErrorPage = document.querySelector('.bg-red-100[role="alert"]');
        if (isErrorPage) {
            console.log("Error page detected, skipping chart initialization.");
            return; // Don't try to initialize charts on error pages
        }

        // Parse JSON data - this will result in null if the Python variable was None
        const pieCfg       = JSON.parse('{{ antibiotic | tojson | safe }}');
        const barCfg       = JSON.parse('{{ source_db  | tojson | safe }}');
        const stackedCfg   = JSON.parse('{{ phenotype  | tojson | safe }}');

        /* helpers – one per chart style */
        const pie = (id, d) => new Chart(id, {
          type: 'pie',
          data: {labels: d.labels, datasets:[{data:d.data, backgroundColor:d.colors}]},
          // Disable legend for pie chart
          options:{responsive:true, plugins:{legend:{display: false}}}
        });
        const bar = (id, d) => new Chart(id, {
          type:'bar',
          data:{
            labels:d.segments.map(s=>s.name),
            datasets:[{data:d.segments.map(s=>s.count), backgroundColor:d.segments.map(s=>s.color)}]
          },
          options:{
            indexAxis:'y',
            // Legend is already disabled here, no change needed
            plugins:{legend:{display:false}},
            scales:{y:{position:'right'}, x:{beginAtZero:true}}
          }
        });
        const stacked = (id, d) => new Chart(id, {
          type:'bar',
          data:{
            labels:['Predicted Phenotypes'],
            datasets:d.segments.map(s=>({label:s.name,data:[s.count],backgroundColor:s.color}))
          },
          options:{
            indexAxis:'y', responsive:true, scales:{x:{stacked:true},y:{stacked:true,display:false}},
            // Disable legend for stacked bar chart
            plugins:{legend:{display: false}}
          }
        });

        // Check if the parsed config is not null before creating the chart
        if (pieCfg)       pie(document.getElementById('antibiotic'), pieCfg);
        if (barCfg)       bar(document.getElementById('sourceDb'),  barCfg);
        if (stackedCfg)   stacked(document.getElementById('phenotype'), stackedCfg);
      });
    </script>
{% endblock %} 