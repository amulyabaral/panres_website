{% extends "base.html" %}

{% block title %}{{ site_name }} - Home{% endblock %}

{% block content %}

    {# *** START ERROR DISPLAY BLOCK *** #}
    {% if show_error %}
    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-md shadow-md" role="alert">
        <p class="font-bold">Error {{ error_code }}</p>
        <p>{{ error_message | default('An unexpected error occurred.', true) }}</p>
        <p class="mt-2 text-sm">You can try returning to the <a href="{{ url_for('index') }}" class="font-medium hover:underline">Homepage</a>.</p>
    </div>
    {% endif %}
    {# *** END ERROR DISPLAY BLOCK *** #}

    {# --- Introduction/Search Section (Only show if NOT showing an error) --- #}
    {% if not show_error %}
    <section class="mb-12 text-center">
        <h2 class="text-3xl font-semibold text-gray-800 mb-3">Welcome to the {{ site_name }}</h2>
        <p class="text-lg text-gray-600 mb-6 max-w-3xl mx-auto">
            Explore antimicrobial resistance (AMR) genes, their predicted phenotypes,
            associated antibiotic classes, and source databases.
        </p>
        {# Removed Search Bar - Add back if needed #}
    </section>

    {# --- Browse Categories Section (Only show if NOT showing an error) --- #}
    <section class="mb-12">
        <h3 class="text-2xl font-semibold text-gray-700 mb-6 text-center">Browse Data</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            {# Standard Card Style #}
            {# Loop through the configuration dict #}
            {% for key, info in index_categories.items() %}
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 hover:shadow-lg transition-shadow duration-200 flex flex-col">
                <h4 class="text-xl font-semibold text-dtu-red mb-2">{{ key }}</h4>
                <p class="text-gray-600 text-sm mb-4 flex-grow">{{ info.description }}</p>
                <div class="text-sm text-gray-500 mb-4">
                    {# Access the count from the category_counts dict using the key #}
                    <span class="font-medium">{{ category_counts.get(key, 'N/A') }}</span> items
                </div>
                {# Standard Button/Link Style - Use the btn class #}
                <a href="{{ url_for('list_items', category_key=key) }}" class="mt-auto btn text-center">
                    View {{ key }}
                </a>
            </div>
            {% else %}
            <p class="text-gray-500 italic md:col-span-2 lg:col-span-4 text-center">No categories found.</p>
            {% endfor %}
        </div>
    </section>

    {# --- Charts Section (Only show if NOT showing an error) --- #}
    <section class="mb-12">
        <h3 class="text-2xl font-semibold text-gray-700 mb-6 text-center">Data Overview</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            {# Antibiotic Classes Chart #}
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <h4 class="text-lg font-semibold text-gray-700 mb-4 text-center">Genes per Antibiotic Class</h4>
                {# Use the updated variable name from app.py #}
                {% if antibiotic_chart_data and antibiotic_chart_data.data %}
                    {# Use the chart-container class for consistent sizing #}
                    <div class="chart-container">
                        <canvas id="antibioticClassChart"></canvas>
                    </div>
                {% else %}
                    <p class="text-gray-500 italic text-center py-4">No data available for antibiotic classes chart.</p>
                {% endif %}
            </div>

            {# Source Databases Chart #}
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <h4 class="text-lg font-semibold text-gray-700 mb-4 text-center">Genes per Source Database</h4>
                 {# Use the updated variable name from app.py #}
                {% if source_db_chart_data and source_db_chart_data.segments %}
                     {# Use the chart-container class for consistent sizing #}
                     <div class="chart-container">
                        <canvas id="sourceDbChart"></canvas>
                    </div>
                {% else %}
                    <p class="text-gray-500 italic text-center py-4">No data available for source databases chart.</p>
                {% endif %}
            </div>
        </div>
    </section>

    {# --- Citation Section (Only show if NOT showing an error) --- #}
    <section class="bg-gray-100 p-6 rounded-lg border border-gray-200 shadow-sm">
        <h3 class="text-xl font-semibold text-gray-700 mb-3">Citation</h3>
        <p class="text-gray-600 text-sm">
            If you use the PanRes database or website, please cite:
        </p>
        <blockquote class="mt-2 text-sm text-gray-800 border-l-4 border-dtu-red pl-4 italic">
            {{ citation_text | safe }}
        </blockquote>
    </section>
    {% endif %} {# End of "if not show_error" block #}

{% endblock %}

{% block scripts %}
    {# Chart.js Scripts #}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    {# <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script> #}

    {# Custom JS for Charts #}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const isErrorPage = document.querySelector('.bg-red-100');
            if (isErrorPage) {
                console.log("Error page detected, skipping chart initialization.");
                return;
            }

            // Simplified Chart Initialization Logic
            const initPieChart = (canvasId, chartData) => {
                const ctx = document.getElementById(canvasId);
                if (!ctx || !chartData || !chartData.data || chartData.data.length === 0) {
                    console.warn(`Canvas #${canvasId} not found or no data provided.`);
                    return;
                }
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            label: `Count (Total: ${chartData.total_count})`,
                            data: chartData.data,
                            backgroundColor: chartData.colors, // Use colors from backend
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // Allow chart to fill container height
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                     label: function(context) {
                                         let label = context.label || '';
                                         if (label) {
                                             label += ': ';
                                         }
                                         if (context.parsed !== null) {
                                             const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                             const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                                             label += `${context.parsed} (${percentage}%)`;
                                         }
                                         return label;
                                     }
                                }
                            }
                        }
                    }
                });
            };

            const initBarChart = (canvasId, chartData) => {
                 const ctx = document.getElementById(canvasId);
                 if (!ctx || !chartData || !chartData.segments || chartData.segments.length === 0) {
                     console.warn(`Canvas #${canvasId} not found or no data provided.`);
                     return;
                 }
                 new Chart(ctx, {
                     type: 'bar',
                     data: {
                         labels: chartData.segments.map(s => s.name),
                         datasets: [{
                             label: `Gene Count (Total: ${chartData.total_count})`,
                             data: chartData.segments.map(s => s.count),
                             backgroundColor: chartData.segments.map(s => s.color),
                             borderColor: chartData.segments.map(s => s.color), // Optional: border
                             borderWidth: 1
                         }]
                     },
                     options: {
                         indexAxis: 'y', // Horizontal bars often better for long labels
                         responsive: true,
                         maintainAspectRatio: false,
                         scales: {
                             x: { beginAtZero: true }
                         },
                         plugins: {
                             legend: { display: false } // Hide legend for bar chart if label is clear
                         }
                     }
                 });
            };

            // Initialize charts using data passed from Flask
            initPieChart('antibioticClassChart', {{ antibiotic_chart_data | tojson | safe }});
            initBarChart('sourceDbChart', {{ source_db_chart_data | tojson | safe }});
            // Add phenotype chart if needed:
            // initBarChart('phenotypeChart', {{ phenotype_chart_data | tojson | safe }});

        });
    </script>
{% endblock %} 