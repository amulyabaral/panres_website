{% extends "base.html" %}

{% block title %}{{ site_name }} - Home{% endblock %}

{% block content %}

    {# *** START ERROR DISPLAY BLOCK *** #}
    {% if show_error %}
    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-md shadow-md" role="alert">
        <p class="font-bold">Error {{ error_code }}</p>
        <p>{{ error_message | default('An unexpected error occurred.', true) }}</p>
        <p class="mt-2 text-sm">You can try returning to the <a href="{{ url_for('index') }}" class="font-medium hover:underline">Homepage</a>.</p>
    </div>
    {% endif %}
    {# *** END ERROR DISPLAY BLOCK *** #}

    {# --- Show content only if NOT showing an error --- #}
    {% if not show_error %}

    {# --- Combined Intro, Search, and Browse Section --- #}
    <section class="mb-8 bg-white p-6 rounded-lg shadow-md border border-gray-200">
        <h2 class="text-3xl font-semibold text-gray-800 mb-3">{{ site_name }}</h2>
        <p class="text-gray-600 text-sm mb-4">
            PanRes (Pan Resistance) is a curated collection of genes conferring resistance to antibiotics, heavy metals, and biocides.
            We have aggregated unique gene sequences from multiple databases like ResFinder, CARD, MegaRes, AMRFinderPlus, ARGANNOT, BacMet,
            and functionally verified genes and unified the ontology.
        </p>

        {# Container for Search #}
        <div class="mb-4"> {# Added margin-bottom #}
            {# Search Form - Autocomplete handled by JS, no action needed #}
            {# Added relative positioning for suggestions dropdown #}
            {# Added onsubmit="return false;" to prevent default submission #}
            <form method="get" class="flex-grow flex items-center gap-0 relative" onsubmit="return false;">
                <label for="search-term" class="sr-only">Search Term</label>
                {# Added autocomplete="off" and event listeners for suggestions #}
                <input type="search" id="search-term" name="q" placeholder="Search genes, classes, phenotypes..."
                       class="flex-grow px-4 py-2 border border-gray-300 rounded-l-md focus:ring-dtu-red focus:border-dtu-red focus:z-10"
                       required autocomplete="off"
                       oninput="getSuggestions(this.value)"
                       onblur="hideSuggestionsDebounced()"
                       aria-haspopup="listbox" {# Accessibility improvement #}
                       aria-controls="suggestions">
                {# Search button can be kept for visual cue or removed if desired #}
                <button type="button" class="inline-flex items-center bg-dtu-red text-white px-4 py-2 rounded-r-md text-sm font-medium border border-dtu-red -ml-px cursor-default"> {# Changed type to button, removed hover effect #}
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"> <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /> </svg>
                    <span class="sr-only">Search</span>
                </button>
                {# Container for suggestions dropdown #}
                {# Added role="listbox" for accessibility #}
                <div id="suggestions" role="listbox"
                     class="absolute left-0 right-0 top-full mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg z-20 hidden overflow-y-auto max-h-60">
                    <!-- Suggestions will be loaded here by JavaScript -->
                </div>
            </form>
        </div>

        {# MOVED descriptive paragraph here #}
        <p class="text-gray-600 text-sm mb-6">
            Find detailed information about each PanRes gene: browse antibiotic classes, predicted antibiotic resistance phenotype(s) and ontology across different resources.
        </p>

        {# MOVED Browse Buttons and GitHub Link here #}
        <div class="flex flex-wrap justify-center md:justify-start items-center gap-2 flex-shrink-0"> {# Added flex-shrink-0 #}
            <a href="{{ url_for('list_items', category_key='Antibiotic Classes') }}" class="inline-block bg-dtu-red hover:bg-opacity-80 text-white px-3 py-2 rounded text-xs font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-dtu-red focus:ring-offset-2 whitespace-nowrap">Browse Class</a>
            <a href="{{ url_for('list_items', category_key='Source Databases') }}" class="inline-block bg-dtu-red hover:bg-opacity-80 text-white px-3 py-2 rounded text-xs font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-dtu-red focus:ring-offset-2 whitespace-nowrap">Browse Source</a>
            <a href="{{ url_for('list_items', category_key='Predicted Phenotypes') }}" class="inline-block bg-dtu-red hover:bg-opacity-80 text-white px-3 py-2 rounded text-xs font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-dtu-red focus:ring-offset-2 whitespace-nowrap">Browse Phenotype</a>
            <a href="https://github.com/genomicepidemiology/PanResOntology" target="_blank" rel="noopener noreferrer" class="inline-flex items-center text-gray-600 hover:text-dtu-red transition-colors duration-200 px-2 py-2" title="View on GitHub">
                <i class="fab fa-github fa-lg"></i>
                <span class="sr-only">GitHub Repo</span>
            </a>
        </div>
    </section>

    {# --- Charts Section (3 Donut Charts Side-by-Side) --- #}
    <section id="charts" class="mb-8">
        <h3 class="text-2xl font-semibold text-gray-700 mb-4 text-center">PanRes by the numbers</h3>

        {# Container to hold chart data attributes #}
        <div id="chart-data-container"
             data-antibiotic="{{ antibiotic | tojson | safe if antibiotic else 'null' }}"
             data-source-db="{{ source_db | tojson | safe if source_db else 'null' }}"
             data-phenotype="{{ phenotype | tojson | safe if phenotype else 'null' }}">
        </div>

        {# Grid for 3 charts side-by-side #}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

            {# Card 1: Antibiotic Classes Chart (Donut) #}
            <div class="bg-white p-3 rounded-lg shadow-md border border-gray-200 flex flex-col">
                <h4 class="text-lg font-semibold text-gray-700 mb-1 text-center">Antibiotic Classes</h4>
                <p class="text-gray-600 text-xs mb-2 text-center">Distribution across top 7 classes + Others</p>
                {% if antibiotic %}
                    <div class="relative h-48 md:h-56 mx-auto w-full max-w-xs mb-2">
                        <canvas id="antibiotic"></canvas>
                    </div>
                    <div class="mt-auto text-center">
                        <a href="{{ url_for('list_items', category_key='Antibiotic Classes') }}"
                           class="inline-block bg-dtu-red hover:bg-opacity-80 text-white px-3 py-1 rounded text-xs font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-dtu-red focus:ring-offset-2">
                            Browse by Class
                        </a>
                    </div>
                {% else %}
                    <p class="text-gray-500 italic text-center py-4 text-sm">No data available.</p>
                {% endif %}
            </div>

            {# Card 2: Source Databases Chart (Donut) #}
            <div class="bg-white p-3 rounded-lg shadow-md border border-gray-200 flex flex-col">
                <h4 class="text-lg font-semibold text-gray-700 mb-1 text-center">Source Databases</h4>
                <p class="text-gray-600 text-xs mb-2 text-center">Relative contribution from sources</p>
                {% if source_db %}
                    <div class="relative h-48 md:h-56 mx-auto w-full max-w-xs mb-2">
                        <canvas id="sourceDb"></canvas>
                    </div>
                    <div class="mt-auto text-center">
                        <a href="{{ url_for('list_items', category_key='Source Databases') }}"
                           class="inline-block bg-dtu-red hover:bg-opacity-80 text-white px-3 py-1 rounded text-xs font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-dtu-red focus:ring-offset-2">
                            Browse by Source
                        </a>
                    </div>
                {% else %}
                    <p class="text-gray-500 italic text-center py-4 text-sm">No data available.</p>
                {% endif %}
            </div>

            {# Card 3: Predicted Phenotypes Chart (Donut) #}
            <div class="bg-white p-3 rounded-lg shadow-md border border-gray-200 flex flex-col">
                <h4 class="text-lg font-semibold text-gray-700 mb-1 text-center">Predicted Phenotypes</h4>
                <p class="text-gray-600 text-xs mb-2 text-center">Distribution across top 7 phenotypes + Others</p>
                {% if phenotype %}
                    <div class="relative h-48 md:h-56 mx-auto w-full max-w-xs mb-2">
                        <canvas id="phenotype"></canvas>
                    </div>
                    <div class="mt-auto text-center">
                        <a href="{{ url_for('list_items', category_key='Predicted Phenotypes') }}"
                           class="inline-block bg-dtu-red hover:bg-opacity-80 text-white px-3 py-1 rounded text-xs font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-dtu-red focus:ring-offset-2">
                            Browse by Phenotype
                        </a>
                    </div>
                {% else %}
                    <p class="text-gray-500 italic text-center py-4 text-sm">No data available.</p>
                {% endif %}
            </div>

        </div>
    </section>
    {# --- END Charts Section --- #}

    {# --- Citation Section (Only show if NOT showing an error) --- #}
    <section class="bg-gray-100 p-6 rounded-lg border border-gray-200 shadow-sm">
        <h3 class="text-xl font-semibold text-gray-700 mb-3">Citation</h3>
        <p class="text-gray-600 text-sm">
            If you use the PanRes database or website, please cite:
        </p>
        <blockquote class="mt-2 text-sm text-gray-800 border-l-4 border-dtu-red pl-4 italic">
            {{ citation_text | safe }}
        </blockquote>
    </section>
    {% endif %} {# End of "if not show_error" block #}

{% endblock %}

{% block scripts %}
    {# Chart.js Core and Datalabels Plugin are included in base.html #}
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // --- Chart Initialization ---

        // 1. Check if we are on an error page; if so, do nothing.
        const isErrorPage = document.querySelector('.bg-red-100[role="alert"]');
        if (isErrorPage) {
            console.log("Error page detected, skipping chart initialization.");
            return;
        }

        // 2. Find the container holding the chart data attributes.
        const chartDataContainer = document.getElementById('chart-data-container');
        if (!chartDataContainer) {
            console.error("Chart data container element (#chart-data-container) not found!");
            // Optionally display a general error message if the container is missing
            const chartsSection = document.getElementById('charts');
            if(chartsSection) {
                chartsSection.innerHTML = '<p class="text-center text-red-600 p-4">Error: Could not load chart data container.</p>';
            }
            return;
        }

        // 3. Safely parse chart data from data attributes with improved error handling.
        let antibioticConfig = null;
        let sourceDbConfig = null;
        let phenotypeConfig = null;

        try {
            // Get the raw data attribute values
            const antibioticData = chartDataContainer.dataset.antibiotic;
            const sourceDbData = chartDataContainer.dataset.sourceDb;
            const phenotypeData = chartDataContainer.dataset.phenotype;
            
            console.log("Raw chart data:", {
                antibiotic: antibioticData,
                sourceDb: sourceDbData,
                phenotype: phenotypeData
            });

            // Parse only if the data attribute exists and is not the string 'null'
            if (antibioticData && antibioticData !== 'null') {
                try {
                    antibioticConfig = JSON.parse(antibioticData);
                    console.log("Parsed antibiotic config:", antibioticConfig);
                } catch (parseError) {
                    console.error("Failed to parse antibiotic data:", parseError);
                    console.log("Raw antibiotic data:", antibioticData);
                }
            }
            
            if (sourceDbData && sourceDbData !== 'null') {
                try {
                    sourceDbConfig = JSON.parse(sourceDbData);
                    console.log("Parsed sourceDb config:", sourceDbConfig);
                } catch (parseError) {
                    console.error("Failed to parse sourceDb data:", parseError);
                    console.log("Raw sourceDb data:", sourceDbData);
                }
            }
            
            if (phenotypeData && phenotypeData !== 'null') {
                try {
                    phenotypeConfig = JSON.parse(phenotypeData);
                    console.log("Parsed phenotype config:", phenotypeConfig);
                } catch (parseError) {
                    console.error("Failed to parse phenotype data:", parseError);
                    console.log("Raw phenotype data:", phenotypeData);
                }
            }
        } catch (e) {
            console.error("Error processing chart data attributes:", e);
            // Display detailed error message to help debugging
            const chartsSection = document.getElementById('charts');
            if(chartsSection) {
                chartsSection.innerHTML = `<div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded">
                    <p class="font-bold">Error: Could not parse chart data.</p>
                    <p class="text-sm mt-2">Error details: ${e.message}</p>
                    <p class="text-sm">Check browser console for more information.</p>
                </div>`;
            }
            return; // Stop if parsing fails
        }

        // Fallback to empty configurations if parsing failed
        antibioticConfig = antibioticConfig || {
            labels: ["No Data"], 
            data: [100], 
            colors: ["#cccccc"],
            total_count: 100
        };
        sourceDbConfig = sourceDbConfig || {
            labels: ["No Data"], 
            data: [100], 
            colors: ["#cccccc"],
            total_count: 100
        };
        phenotypeConfig = phenotypeConfig || {
            labels: ["No Data"], 
            data: [100], 
            colors: ["#cccccc"],
            total_count: 100
        };

        // 4. Helper function to create a Donut Chart
        const createDonutChart = (canvasId, config) => {
            const canvasElement = document.getElementById(canvasId);
            const chartContainer = canvasElement ? canvasElement.closest('div.relative') : null; // Find the parent container

            // Basic validation: Check if canvas exists
            if (!canvasElement) {
                console.error(`Canvas element with id '${canvasId}' not found.`);
                return null; // Cannot create chart
            }

            // Data validation: Check if config is valid and has necessary parts
            if (!config || !config.labels || !config.data || !config.colors || !config.total_count ||
                config.labels.length !== config.data.length || config.labels.length !== config.colors.length || config.data.length === 0) {
                console.warn(`Invalid or incomplete chart config for canvas id '${canvasId}'. Config:`, config);
                if (chartContainer) {
                    chartContainer.innerHTML = `<p class="text-center text-gray-500 text-sm p-4">${canvasId.charAt(0).toUpperCase() + canvasId.slice(1)} data unavailable.</p>`;
                }
                return null; // Cannot create chart with invalid data
            }

            // Get canvas context
            const ctx = canvasElement.getContext('2d');
            if (!ctx) {
                 console.error(`Failed to get 2D context for canvas id '${canvasId}'.`);
                 if (chartContainer) {
                    chartContainer.innerHTML = `<p class="text-center text-gray-500 text-sm p-4">Error initializing ${canvasId} chart.</p>`;
                 }
                 return null;
            }

            // Create the chart
            try {
                return new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: config.labels,
                        datasets: [{
                            label: 'Count', // Optional dataset label
                            data: config.data,
                            backgroundColor: config.colors,
                            borderColor: '#ffffff', // White border between segments
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // Allow chart to fill container height
                        cutout: '60%', // Adjust doughnut thickness (percentage or pixels)
                        plugins: {
                            legend: {
                                display: false // Hide the default legend
                            },
                            tooltip: {
                                // Customize tooltip appearance and content
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        const value = context.raw; // The raw data value for this segment
                                        const total = config.total_count; // Use total_count from config
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        label += `${value} (${percentage}%)`;
                                        return label;
                                    }
                                }
                            },
                            // Ensure datalabels plugin (if registered) doesn't interfere if not needed
                            datalabels: {
                                display: false // Explicitly disable datalabels on the chart segments
                            }
                        }
                    }
                });
            } catch (chartError) {
                console.error(`Error creating chart '${canvasId}':`, chartError);
                 if (chartContainer) {
                    chartContainer.innerHTML = `<p class="text-center text-red-600 text-sm p-4">Error rendering ${canvasId} chart.</p>`;
                 }
                return null;
            }
        };

        // 5. Initialize each chart if its config data is valid
        createDonutChart('antibiotic', antibioticConfig);
        createDonutChart('sourceDb', sourceDbConfig);
        createDonutChart('phenotype', phenotypeConfig);

      }); // End DOMContentLoaded for charts

      // --- Autocomplete Suggestion Logic (Keep existing logic below) ---
      let suggestionTimeout; // To debounce hiding suggestions
      let fetchController; // To abort previous fetch requests

      function getSuggestions(query) {
          const suggestionsDiv = document.getElementById('suggestions');
          const searchTermInput = document.getElementById('search-term');

          // Abort any ongoing fetch request
          if (fetchController) {
              fetchController.abort();
          }

          if (query.length < 2) { // Minimum characters to trigger search
              suggestionsDiv.innerHTML = '';
              suggestionsDiv.classList.add('hidden');
              searchTermInput.removeAttribute('aria-activedescendant'); // Accessibility
              return;
          }

          // Show loading indicator (optional)
          suggestionsDiv.innerHTML = '<div class="px-4 py-2 text-sm text-gray-500">Loading...</div>';
          suggestionsDiv.classList.remove('hidden');

          // Create a new AbortController for this request
          fetchController = new AbortController();
          const signal = fetchController.signal;

          // Fetch suggestions from the backend
          fetch(`/autocomplete?q=${encodeURIComponent(query)}`, { signal })
              .then(response => {
                  if (!response.ok) {
                      throw new Error(`HTTP error! status: ${response.status}`);
                  }
                  return response.json();
               })
              .then(data => {
                  suggestionsDiv.innerHTML = ''; // Clear previous suggestions/loading
                  if (data && data.length > 0) {
                      const list = document.createElement('ul');
                      list.id = 'suggestion-list'; // ID for aria-controls
                      data.forEach((item, index) => {
                          const listItem = document.createElement('li');
                          listItem.id = `suggestion-${index}`; // Unique ID for each item
                          listItem.setAttribute('role', 'option');

                          // --- Create Indicator ---
                          let indicatorIcon = 'fa-question-circle'; // Default icon
                          let indicatorColor = 'text-gray-400';
                          let indicatorTitle = item.type_indicator || 'Other'; // Use title from backend

                          switch(item.type_indicator) {
                              case 'Gene':
                                  indicatorIcon = 'fa-dna';
                                  indicatorColor = 'text-blue-500';
                                  break;
                              case 'Class':
                                  indicatorIcon = 'fa-layer-group';
                                  indicatorColor = 'text-green-500';
                                  break;
                              case 'Phenotype':
                                  indicatorIcon = 'fa-tags';
                                  indicatorColor = 'text-purple-500';
                                  break;
                              case 'Database':
                                  indicatorIcon = 'fa-database';
                                  indicatorColor = 'text-orange-500';
                                  break;
                              case 'Ontology Class':
                                  indicatorIcon = 'fa-sitemap';
                                  indicatorColor = 'text-indigo-500';
                                  break;
                               case 'Resource':
                                  indicatorIcon = 'fa-link';
                                  indicatorColor = 'text-teal-500';
                                  break;
                          }
                          const indicatorHtml = `<i class="fas ${indicatorIcon} ${indicatorColor} mr-2 fa-fw" title="${indicatorTitle}"></i>`;
                          // --- End Indicator ---

                          // Use 'mousedown' to register click before 'blur' hides the div
                          // Use an inner link for navigation
                          listItem.innerHTML = `<a href="${item.link}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-dtu-red flex items-center suggestion-link">
                                                    ${indicatorHtml}
                                                    <span class="flex-grow">${item.display_name}</span>
                                                    <span class="text-xs text-gray-500 ml-2">(${item.id})</span>
                                                </a>`;
                          // Prevent blur when clicking suggestion link
                          listItem.addEventListener('mousedown', (e) => {
                              // Allow middle-click/ctrl-click to open in new tab
                              if (e.button === 0 && !e.ctrlKey && !e.metaKey) {
                                  window.location.href = item.link;
                              }
                          });
                          list.appendChild(listItem);
                      });
                      suggestionsDiv.appendChild(list);
                      suggestionsDiv.classList.remove('hidden');
                  } else {
                      // Show "No results" message
                      suggestionsDiv.innerHTML = '<div class="px-4 py-2 text-sm text-gray-500">No results found.</div>';
                      suggestionsDiv.classList.remove('hidden'); // Keep div visible to show message
                      searchTermInput.removeAttribute('aria-activedescendant');
                  }
              })
              .catch(error => {
                  if (error.name === 'AbortError') {
                      // console.log('Fetch aborted'); // Ignore abort errors silently
                  } else {
                      console.error('Error fetching suggestions:', error); // Keep critical error log
                      suggestionsDiv.innerHTML = '<div class="px-4 py-2 text-sm text-red-600">Error loading suggestions.</div>';
                      suggestionsDiv.classList.remove('hidden'); // Show error
                      searchTermInput.removeAttribute('aria-activedescendant');
                  }
              })
              .finally(() => {
                  // Clear the controller when fetch is done or aborted
                  fetchController = null;
              });
      }

      function hideSuggestions() {
          const suggestionsDiv = document.getElementById('suggestions');
          const searchTermInput = document.getElementById('search-term');
          suggestionsDiv.classList.add('hidden');
          suggestionsDiv.innerHTML = ''; // Clear content when hiding
          searchTermInput.removeAttribute('aria-activedescendant');
      }

      // Debounce hiding to allow clicking on suggestions
      function hideSuggestionsDebounced() {
          clearTimeout(suggestionTimeout);
          suggestionTimeout = setTimeout(hideSuggestions, 200); // Delay allows click
      }

      // --- Keyboard Navigation for Suggestions ---
      const searchTermInput = document.getElementById('search-term');
      const suggestionsDiv = document.getElementById('suggestions');
      let activeSuggestionIndex = -1;

      searchTermInput.addEventListener('keydown', (e) => {
          const suggestionList = suggestionsDiv.querySelector('#suggestion-list');
          if (!suggestionList || suggestionsDiv.classList.contains('hidden')) {
              activeSuggestionIndex = -1;
              return;
          }

          const items = suggestionList.querySelectorAll('li[role="option"]');
          if (!items.length) return;

          if (e.key === 'ArrowDown') {
              e.preventDefault(); // Prevent cursor move in input
              activeSuggestionIndex++;
              if (activeSuggestionIndex >= items.length) activeSuggestionIndex = 0;
              updateActiveSuggestion(items);
          } else if (e.key === 'ArrowUp') {
              e.preventDefault(); // Prevent cursor move in input
              activeSuggestionIndex--;
              if (activeSuggestionIndex < 0) activeSuggestionIndex = items.length - 1;
              updateActiveSuggestion(items);
          } else if (e.key === 'Enter') {
              if (activeSuggestionIndex >= 0 && activeSuggestionIndex < items.length) {
                  e.preventDefault(); // Prevent form submission
                  const activeLink = items[activeSuggestionIndex].querySelector('a.suggestion-link');
                  if (activeLink) {
                      // Navigate using the link's href
                      window.location.href = activeLink.href;
                  }
              }
              // Allow default form submission if Enter is pressed without an active suggestion?
              // Currently form submission is prevented by onsubmit="return false;"
          } else if (e.key === 'Escape') {
              hideSuggestions();
          } else {
              // Reset index if user types other keys
              activeSuggestionIndex = -1;
          }
      });

      function updateActiveSuggestion(items) {
          items.forEach((item, index) => {
              const link = item.querySelector('a.suggestion-link');
              if (index === activeSuggestionIndex) {
                  item.classList.add('bg-gray-100'); // Highlight active item
                  link?.classList.add('text-dtu-red');
                  searchTermInput.setAttribute('aria-activedescendant', item.id);
                  item.scrollIntoView({ block: 'nearest' }); // Ensure visible
              } else {
                  item.classList.remove('bg-gray-100');
                  link?.classList.remove('text-dtu-red');
              }
          });
      }

      // Optional: Hide suggestions if clicked outside the search input and suggestions list
      document.addEventListener('click', function(event) {
          const searchForm = searchTermInput.closest('form');
          if (searchForm && !searchForm.contains(event.target)) {
              // Check if the click was outside the form (input + suggestions div)
              hideSuggestions();
          }
      });

    </script>
{% endblock %} 