{% extends "base.html" %}

{% block title %}{{ site_name }} - Home{% endblock %}

{% block content %}

    {% if show_error %}
    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-md shadow-md" role="alert">
        <p class="font-bold">Error {{ error_code }}</p>
        <p>{{ error_message | default('An unexpected error occurred.', true) }}</p>
        <p class="mt-2 text-sm">You can try returning to the <a href="{{ url_for('index') }}" class="font-medium hover:underline">Homepage</a>.</p>
    </div>
    {% endif %}

    {% if not show_error %}

    <section class="mb-8 bg-white p-6 rounded-lg shadow-md border border-gray-200">
        <h2 class="text-3xl font-semibold text-gray-800 mb-3">{{ site_name }}</h2>
        <p class="text-gray-600 text-sm mb-4">
            PanRes (Pan Resistance) is a curated collection of genes conferring resistance to antibiotics, heavy metals, and biocides.
            We have aggregated unique gene sequences from multiple databases like ResFinder, CARD, MegaRes, AMRFinderPlus, ARGANNOT, BacMet,
            and functionally verified genes and unified the ontology.
        </p>

        <div class="mb-4">
            <form method="get" class="flex-grow flex items-center gap-0 relative" onsubmit="return false;">
                <label for="search-term" class="sr-only">Search Term</label>
                <input type="search" id="search-term" name="q" placeholder="Search genes, classes, phenotypes..."
                       class="flex-grow px-4 py-2 border border-gray-300 rounded-l-md focus:ring-dtu-red focus:border-dtu-red focus:z-10"
                       required autocomplete="off"
                       oninput="getSuggestions(this.value)"
                       onblur="hideSuggestionsDebounced()"
                       aria-haspopup="listbox"
                       aria-controls="suggestions">
                <button type="button" class="inline-flex items-center bg-dtu-red text-white px-4 py-2 rounded-r-md text-sm font-medium border border-dtu-red -ml-px cursor-default">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"> <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /> </svg>
                    <span class="sr-only">Search</span>
                </button>
                <div id="suggestions" role="listbox"
                     class="absolute left-0 right-0 top-full mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg z-20 hidden overflow-y-auto max-h-60">
                </div>
            </form>
        </div>

        <p class="text-gray-600 text-sm mb-6">
            Find detailed information about each PanRes gene: browse antibiotic classes, predicted antibiotic resistance phenotype(s) and ontology across different resources.
        </p>

        <div class="flex flex-wrap justify-center md:justify-start items-center gap-2 flex-shrink-0">
            <a href="{{ url_for('list_items', category_key='Antibiotic Classes') }}" class="inline-block bg-dtu-red hover:bg-opacity-80 text-white px-3 py-2 rounded text-xs font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-dtu-red focus:ring-offset-2 whitespace-nowrap">Browse Class</a>
            <a href="{{ url_for('list_items', category_key='Source Databases') }}" class="inline-block bg-dtu-red hover:bg-opacity-80 text-white px-3 py-2 rounded text-xs font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-dtu-red focus:ring-offset-2 whitespace-nowrap">Browse Source</a>
            <a href="{{ url_for('list_items', category_key='Predicted Phenotypes') }}" class="inline-block bg-dtu-red hover:bg-opacity-80 text-white px-3 py-2 rounded text-xs font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-dtu-red focus:ring-offset-2 whitespace-nowrap">Browse Phenotype</a>
            <a href="https://github.com/genomicepidemiology/PanResOntology" target="_blank" rel="noopener noreferrer" class="inline-flex items-center text-gray-600 hover:text-dtu-red transition-colors duration-200 px-2 py-2" title="View on GitHub">
                <i class="fab fa-github fa-lg"></i>
                <span class="sr-only">GitHub Repo</span>
            </a>
        </div>
    </section>

    <section class="bg-gray-100 p-6 rounded-lg border border-gray-200 shadow-sm">
        <h3 class="text-xl font-semibold text-gray-700 mb-3">Citation</h3>
        <p class="text-gray-600 text-sm">
            If you use the PanRes database or website, please cite:
        </p>
        <blockquote class="mt-2 text-sm text-gray-800 border-l-4 border-dtu-red pl-4 italic">
            {{ citation_text | safe }}
        </blockquote>
    </section>
    {% endif %}

{% endblock %}

{% block scripts %}
    <script>
      let suggestionTimeout;
      let fetchController;

      function getSuggestions(query) {
          const suggestionsDiv = document.getElementById('suggestions');
          const searchTermInput = document.getElementById('search-term');

          if (fetchController) {
              fetchController.abort();
          }

          if (query.length < 2) {
              suggestionsDiv.classList.add('hidden');
              searchTermInput.removeAttribute('aria-activedescendant');
              return;
          }

          suggestionsDiv.classList.remove('hidden');

          fetchController = new AbortController();
          const signal = fetchController.signal;

          fetch(`/autocomplete?q=${encodeURIComponent(query)}`, { signal })
              .then(response => {
                  if (!response.ok) {
                      throw new Error(`HTTP error! status: ${response.status}`);
                  }
                  return response.json();
               })
              .then(data => {
                  suggestionsDiv.innerHTML = '';
                  if (data && data.length > 0) {
                      const list = document.createElement('ul');
                      list.id = 'suggestion-list';
                      data.forEach((item, index) => {
                          const listItem = document.createElement('li');
                          listItem.id = `suggestion-${index}`;
                          listItem.setAttribute('role', 'option');

                          let indicatorIcon = 'fa-question-circle';
                          let indicatorColor = 'text-gray-400';
                          let indicatorTitle = item.type_indicator || 'Other';

                          switch(item.type_indicator) {
                              case 'Gene':
                                  indicatorIcon = 'fa-dna';
                                  indicatorColor = 'text-blue-500';
                                  break;
                              case 'Class':
                                  indicatorIcon = 'fa-layer-group';
                                  indicatorColor = 'text-green-500';
                                  break;
                              case 'Phenotype':
                                  indicatorIcon = 'fa-tags';
                                  indicatorColor = 'text-purple-500';
                                  break;
                              case 'Database':
                                  indicatorIcon = 'fa-database';
                                  indicatorColor = 'text-orange-500';
                                  break;
                              case 'Ontology Class':
                                  indicatorIcon = 'fa-sitemap';
                                  indicatorColor = 'text-indigo-500';
                                  break;
                               case 'Resource':
                                  indicatorIcon = 'fa-link';
                                  indicatorColor = 'text-teal-500';
                                  break;
                          }
                          const indicatorHtml = `<i class="fas ${indicatorIcon} ${indicatorColor} mr-2 fa-fw" title="${indicatorTitle}"></i>`;

                          listItem.innerHTML = `<a href="${item.link}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-dtu-red flex items-center suggestion-link">
                                                    ${indicatorHtml}
                                                    <span class="flex-grow">${item.display_name}</span>
                                                    <span class="text-xs text-gray-500 ml-2">(${item.id})</span>
                                                </a>`;
                          listItem.addEventListener('mousedown', (e) => {
                              if (e.button === 0 && !e.ctrlKey && !e.metaKey) {
                                  window.location.href = item.link;
                              }
                          });
                          list.appendChild(listItem);
                      });
                      suggestionsDiv.appendChild(list);
                      suggestionsDiv.classList.remove('hidden');
                  } else {
                      suggestionsDiv.classList.add('hidden');
                      searchTermInput.removeAttribute('aria-activedescendant');
                  }
              })
              .catch(error => {
                  if (error.name === 'AbortError') {
                  } else {
                      suggestionsDiv.classList.add('hidden');
                      searchTermInput.removeAttribute('aria-activedescendant');
                      console.error("Autocomplete error:", error);
                  }
              })
              .finally(() => {
                  fetchController = null;
              });
      }

      function hideSuggestions() {
          const suggestionsDiv = document.getElementById('suggestions');
          const searchTermInput = document.getElementById('search-term');
          suggestionsDiv.classList.add('hidden');
          suggestionsDiv.innerHTML = '';
          searchTermInput.removeAttribute('aria-activedescendant');
      }

      function hideSuggestionsDebounced() {
          clearTimeout(suggestionTimeout);
          suggestionTimeout = setTimeout(hideSuggestions, 200);
      }

      const searchTermInput = document.getElementById('search-term');
      const suggestionsDiv = document.getElementById('suggestions');
      let activeSuggestionIndex = -1;

      searchTermInput.addEventListener('keydown', (e) => {
          const suggestionList = suggestionsDiv.querySelector('#suggestion-list');
          if (!suggestionList || suggestionsDiv.classList.contains('hidden')) {
              activeSuggestionIndex = -1;
              return;
          }

          const items = suggestionList.querySelectorAll('li[role="option"]');
          if (!items.length) return;

          if (e.key === 'ArrowDown') {
              e.preventDefault();
              activeSuggestionIndex++;
              if (activeSuggestionIndex >= items.length) activeSuggestionIndex = 0;
              updateActiveSuggestion(items);
          } else if (e.key === 'ArrowUp') {
              e.preventDefault();
              activeSuggestionIndex--;
              if (activeSuggestionIndex < 0) activeSuggestionIndex = items.length - 1;
              updateActiveSuggestion(items);
          } else if (e.key === 'Enter') {
              if (activeSuggestionIndex >= 0 && activeSuggestionIndex < items.length) {
                  e.preventDefault();
                  const activeLink = items[activeSuggestionIndex].querySelector('a.suggestion-link');
                  if (activeLink) {
                      window.location.href = activeLink.href;
                  }
              }
          } else if (e.key === 'Escape') {
              hideSuggestions();
          } else {
              activeSuggestionIndex = -1;
          }
      });

      function updateActiveSuggestion(items) {
          items.forEach((item, index) => {
              const link = item.querySelector('a.suggestion-link');
              if (index === activeSuggestionIndex) {
                  item.classList.add('bg-gray-100');
                  link?.classList.add('text-dtu-red');
                  searchTermInput.setAttribute('aria-activedescendant', item.id);
                  item.scrollIntoView({ block: 'nearest' });
              } else {
                  item.classList.remove('bg-gray-100');
                  link?.classList.remove('text-dtu-red');
              }
          });
      }

      document.addEventListener('click', function(event) {
          const searchForm = searchTermInput.closest('form');
          if (searchForm && !searchForm.contains(event.target)) {
              hideSuggestions();
          }
      });

    </script>
{% endblock %} 